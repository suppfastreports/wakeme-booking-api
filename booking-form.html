<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WakeMe - Онлайн запись</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Unbounded:wght@200;300;400;500;600;700;800;900&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            margin: 0;
            padding: 0;
            outline: none;
            border: none;
        }

        body {
            font-family: 'Unbounded', sans-serif;
            background: white;
            min-height: 100vh;
            margin: 0;
            padding: 0;
            outline: none;
            border: none;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 40px;
        }

        .location-section {
            grid-column: 1;
        }

        .calendar-section {
            grid-column: 2;
        }

        .service-section {
            grid-column: 3;
        }

        .time-section {
            grid-column: 4;
            padding-top: 10px;
        }

        .section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 16px;
            transition: all 0.2s ease;
        }


        .location-options {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .location-btn {
            padding: 12px 16px;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: left;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .location-btn:hover {
            background: rgba(100, 215, 242, 0.05);
        }

        .location-btn.selected {
            background: #64D7F2;
            color: white;
        }

        .location-btn.selected .location-name {
            color: white;
        }

        .location-btn.selected .feature-item {
            color: rgba(255, 255, 255, 0.9);
        }

        .location-name {
            font-family: 'Unbounded', sans-serif;
            font-size: 12px;
            font-weight: 500;
            color: #2c2c2c;
            margin-bottom: 4px;
        }

        .location-address {
            font-family: 'Unbounded', sans-serif;
            font-size: 11px;
            font-weight: 300;
            color: #666;
        }

        .location-features {
            margin-top: 8px;
        }

        .feature-item {
            font-family: 'Unbounded', sans-serif;
            font-size: 9px;
            font-weight: 300;
            color: #666;
            line-height: 1.4;
            margin-bottom: 2px;
        }

        .feature-item:last-child {
            margin-bottom: 0;
        }

        .feature-item em {
            font-style: italic;
        }

        .location-map {
            width: 100%;
            height: 200px;
            background: #f8f9fa;
            border-radius: 12px;
            margin-top: 16px;
            position: relative;
            overflow: hidden;
            border: 1px solid #e9ecef;
        }

        .map-pin {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            background: #ff4444;
            border-radius: 50% 50% 50% 0;
            transform: translate(-50%, -50%) rotate(-45deg);
        }

        .map-pin::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(45deg);
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
        }

        .map-fullscreen {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #ddd;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
            color: #666;
        }

        .duration-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .duration-option {
            padding: 10px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            background: white;
        }

        .duration-option:hover {
            background: rgba(100, 215, 242, 0.05);
        }

        .duration-option.selected {
            background: #64D7F2;
            color: white;
        }

        .duration-option.selected .duration-price {
            color: rgba(255, 255, 255, 0.9);
        }

        .duration-option.selected .duration-time {
            color: white;
        }

        .duration-time {
            font-size: 14px;
            font-weight: 500;
            color: #2c2c2c;
            margin-bottom: 2px;
        }

        .duration-price {
            font-size: 12px;
            font-weight: 500;
            color: #999;
        }

        .section-divider {
            height: 1px;
            background: #e9ecef;
            margin: 16px 0;
        }

        .trainer-options {
            display: flex;
            flex-direction: row;
            gap: 8px;
            width: 100%;
        }

        .trainer-btn {
            font-family: 'Unbounded', sans-serif;
            padding: 12px 16px;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            font-size: 12px;
            font-weight: 400;
            margin-bottom: 4px;
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            width: 100%;
        }

        .trainer-btn:hover {
            background: rgba(100, 215, 242, 0.05);
        }

        .trainer-btn.selected {
            background: #64D7F2;
            color: white;
        }

        .trainer-price {
            font-size: 12px;
            font-weight: 500;
            color: #999;
            margin-top: 2px;
        }

        .trainer-btn.selected .trainer-price {
            color: rgba(255, 255, 255, 0.8);
        }


        .booking-form {
            background: #f8f9fa;
            border-radius: 16px;
            padding: 30px;
            margin-top: -20px;
        }

        .form-header {
            text-align: left;
            margin-bottom: 20px;
        }

        .form-title {
            font-family: 'Unbounded', sans-serif;
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 12px;
        }

        .form-description {
            font-family: 'Unbounded', sans-serif;
            font-size: 12px;
            font-weight: 400;
            color: #666;
            margin-bottom: 24px;
        }

        /* Popup Styles */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .popup-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .popup {
            background: white;
            border-radius: 16px;
            padding: 32px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .popup-overlay.show .popup {
            transform: scale(1);
        }

        .popup-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
        }

        .popup-icon.success {
            background: #d4edda;
            color: #155724;
        }

        .popup-icon.error {
            background: #f8d7da;
            color: #721c24;
        }

        .popup-title {
            font-family: 'Unbounded', sans-serif;
            font-size: 20px;
            font-weight: 600;
            color: #333;
            margin-bottom: 12px;
        }

        .popup-message {
            font-family: 'Unbounded', sans-serif;
            font-size: 14px;
            font-weight: 400;
            color: #666;
            margin-bottom: 24px;
            line-height: 1.5;
        }

        .popup-button {
            font-family: 'Unbounded', sans-serif;
            background: #64D7F2;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .popup-button:hover {
            background: #4BC5E8;
        }

        .booking-form form {
            display: flex;
            gap: 8px;
            align-items: center;
            width: 100%;
            align-items: stretch;
        }

        .form-group {
            flex: 0.8;
            margin-bottom: 0;
            display: flex;
            align-items: center;
        }

        .booking-btn {
            flex-shrink: 0;
            width: 250px;
            height: 48px;
            padding: 0 32px;
            margin: 0;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
        }



        .form-group {
            margin-bottom: 20px;
        }


        .form-input {
            font-family: 'Unbounded', sans-serif;
            width: 100%;
            padding: 0 16px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 400;
            transition: all 0.2s;
            background: white;
            height: 48px;
            margin: 0;
            box-sizing: border-box;
        }

        .form-input:focus {
            outline: none;
            background: white;
        }

        .form-input::placeholder {
            font-size: 12px;
            font-weight: 300;
            color: #999;
        }

        .booking-btn {
            font-family: 'Unbounded', sans-serif;
            background: #64D7F2;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 400;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .booking-btn:hover {
            background: #4BC5E8;
        }

        .booking-btn:focus {
            outline: none;
        }

        /* Убираем обводки со всех кнопок при фокусе */
        button:focus {
            outline: none;
        }

        /* Убираем все обводки с input и button */
        input, button {
            border: none !important;
            outline: none !important;
        }

        .booking-form * {
            box-sizing: border-box;
        }

        .booking-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .time-slots-section {
            margin-top: 20px;
        }

        .time-slots-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 8px;
            margin-top: 16px;
        }

        .time-slot {
            padding: 12px 8px;
            border-radius: 6px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            font-weight: 500;
            background: white;
        }

        .time-slot:hover {
            background: rgba(100, 215, 242, 0.05);
        }

        .time-slot.selected {
            background: #64D7F2;
            color: white;
        }

        .time-slot.unavailable {
            background: #f5f5f5;
            color: #ccc;
            cursor: not-allowed;
        }

        /* Skeleton loading animation */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
            border-radius: 8px;
        }

        @keyframes skeleton-loading {
            0% {
                background-position: 200% 0;
            }
            100% {
                background-position: -200% 0;
            }
        }

        .time-slot.skeleton {
            height: 48px;
            margin-bottom: 8px;
        }

        .calendar-date.skeleton {
            height: 32px;
            width: 32px;
            border-radius: 50%;
        }

        .total-info {
            background: rgba(100, 215, 242, 0.05);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
            text-align: center;
        }

        .total-amount {
            font-size: 24px;
            font-weight: 700;
            color: #64D7F2;
            margin-bottom: 4px;
        }

        .total-details {
            font-size: 14px;
            color: #666;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .error {
            text-align: center;
            padding: 20px;
            color: #ff4444;
            background: #fff5f5;
            border-radius: 8px;
        }

        /* Calendar Styles */

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .calendar-nav {
            background: #f8f9fa;
            border-radius: 4px;
            width: 28px;
            height: 28px;
            color: #666;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .calendar-nav:hover {
            background: #64D7F2;
            color: white;
        }

        .calendar-month {
            font-size: 14px;
            font-weight: 500;
            color: #2c2c2c;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }

        .calendar-day {
            text-align: center;
            padding: 6px 2px;
            font-size: 11px;
            color: #999;
            font-weight: 500;
        }

        .calendar-date {
            text-align: center;
            padding: 6px 2px;
            font-size: 12px;
            color: #2c2c2c;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s ease;
            font-weight: 400;
        }

        .calendar-date:hover {
            background: rgba(100, 215, 242, 0.1);
        }

        .calendar-date.selected {
            background: #64D7F2;
            color: white;
        }

        .calendar-date.disabled {
            opacity: 0.3;
            cursor: not-allowed;
            color: #999;
            background: transparent;
        }

        .calendar-date.disabled:hover {
            background: transparent;
        }

        .calendar-date.no-slots {
            color: #999;
            opacity: 0.5;
            cursor: not-allowed;
            background: #f5f5f5;
        }

        .calendar-date.no-slots:hover {
            background: #f5f5f5;
        }

        .calendar-date.other-month {
            color: #999;
            cursor: not-allowed;
            opacity: 0.3;
        }

        .calendar-date.other-month:hover {
            background: transparent;
            transform: none;
        }

        /* Mobile styles */
        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr 1fr;
                gap: 20px;
            }

            .location-section {
                grid-column: 1;
            }

            .calendar-section {
                grid-column: 2;
            }

            .service-section {
                grid-column: 1;
            }

            .time-section {
                grid-column: 2;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 0 5%;
                max-width: 90%;
            }
            
            .main-content {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .location-section,
            .calendar-section,
            .service-section,
            .time-section {
                grid-column: 1;
            }
            
            /* Секция времени теперь работает с реальным API */

            .duration-options {
                grid-template-columns: 1fr 1fr;
            }

            .time-slots-grid {
                grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            }

            .booking-form form {
                flex-direction: column;
                gap: 16px;
                align-items: center;
            }

            .form-group {
                margin-bottom: 16px;
                min-width: auto;
                width: 100%;
            }

            .booking-btn {
                min-width: auto;
                width: 100%;
                max-width: 300px;
            }
        }

        /* Extra small screens */
        @media (max-width: 480px) {
            .container {
                padding: 0 2%;
                max-width: 95%;
            }
            
            .duration-options {
                grid-template-columns: 1fr 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Main Content -->
        <div class="main-content">
            <!-- Location Selection -->
            <div class="section location-section">
                <div class="location-options">
                    <button class="location-btn selected" data-location="DUBAI_HARBOUR_MARINA">
                        <div class="location-name">Marina Harbour</div>
                        <div class="location-features">
                            <div class="feature-item">• удобное расположение в центре города</div>
                            <div class="feature-item">• вид на колесо обозрения Ain Dubai, JBR и Address Beach Residences</div>
                            <div class="feature-item">• кристально-голубая вода</div>
                        </div>
                    </button>
                    <button class="location-btn" data-location="DUBAI_CREEK_HARBOUR">
                        <div class="location-name">Creek Harbour</div>
                        <div class="location-features">
                            <div class="feature-item">• локация без сторонних волн</div>
                            <div class="feature-item">• закат с видом на <em>Burj Khalifa</em></div>
                            <div class="feature-item">• нет <em>Jet Ski</em></div>
                        </div>
                    </button>
                </div>
            </div>

            <!-- Calendar Section -->
            <div class="section calendar-section">
                <div class="calendar-header">
                    <button class="calendar-nav" onclick="changeMonth(-1)">‹</button>
                    <div class="calendar-month">Октябрь 2025</div>
                    <button class="calendar-nav" onclick="changeMonth(1)">›</button>
                </div>
                <div class="calendar-grid">
                    <!-- Calendar days and dates will be dynamically generated by JS -->
                </div>
            </div>

            <!-- Service & Trainer Selection -->
            <div class="section service-section">
                <div class="duration-options">
                    <div class="duration-option" data-duration="30">
                        <div class="duration-time">30 мин</div>
                        <div class="duration-price">410 AED</div>
                    </div>
                    <div class="duration-option" data-duration="45">
                        <div class="duration-time">45 мин</div>
                        <div class="duration-price">593 AED</div>
                    </div>
                    <div class="duration-option" data-duration="60">
                        <div class="duration-time">60 мин</div>
                        <div class="duration-price">788 AED</div>
                    </div>
                    <div class="duration-option" data-duration="90">
                        <div class="duration-time">90 мин</div>
                        <div class="duration-price">1 197 AED</div>
                    </div>
                    <div class="duration-option" data-duration="120">
                        <div class="duration-time">120 мин</div>
                        <div class="duration-price">1 575 AED</div>
                    </div>
                </div>
                
                <div class="section-divider"></div>
                
                <div class="trainer-options">
                    <button class="trainer-btn" data-trainer="with">
                        <span>С тренером</span>
                        <span class="trainer-price" id="trainerPrice">+COACH</span>
                    </button>
                    <button class="trainer-btn" data-trainer="without">
                        <span>Без тренера</span>
                    </button>
                </div>
            </div>

            <!-- Time Selection -->
            <div class="section time-section">
                <div class="time-slots-grid" id="timeSlots">
                    <div class="time-slot skeleton"></div>
                    <div class="time-slot skeleton"></div>
                    <div class="time-slot skeleton"></div>
                    <div class="time-slot skeleton"></div>
                    <div class="time-slot skeleton"></div>
                    <div class="time-slot skeleton"></div>
                </div>
            </div>
        </div>


        <!-- Booking Form -->
        <div class="booking-form">
            <div class="form-header">
                <div class="form-title">Заполните форму</div>
                <div class="form-description">Мы свяжемся с вами в WhatsApp для подтверждения даты</div>
            </div>
            <form id="bookingForm">
                <div class="form-group">
                    <input type="text" id="clientName" class="form-input" required placeholder="Имя">
                </div>
                
                <div class="form-group">
                    <input type="tel" id="clientPhone" class="form-input" required placeholder="Телефон">
                </div>
                
                <button type="submit" class="booking-btn" id="bookingBtn">
                    Забронировать
                </button>
            </form>
        </div>
    </div>

    <!-- Popup -->
    <div class="popup-overlay" id="popupOverlay">
        <div class="popup">
            <div class="popup-icon" id="popupIcon"></div>
            <div class="popup-title" id="popupTitle"></div>
            <div class="popup-message" id="popupMessage"></div>
            <button class="popup-button" id="popupButton">Продолжить</button>
        </div>
    </div>

    <script>
        // API Configuration
        const API_CONFIG = {
            proxyUrl: 'https://wakeme-booking-api-production.up.railway.app',
            companyId: 1252189,
            locations: {
                'DUBAI_HARBOUR_MARINA': {
                    staffId: 2742288,
                    services: {
                        30: 12199769,   // 30 MIN (+20 min of mooring)
                        45: 12952120,   // 45 MIN (+20 min of mooring)
                        60: 12200654,   // 60 MIN (+20 min of mooring)
                        90: 12200653,   // 90 MIN (+20 min of mooring)
                        120: 12203754   // 120 MIN (+20 min of mooring)
                    }
                },
                'DUBAI_CREEK_HARBOUR': {
                    staffId: 2780637,
                    services: {
                        30: 12396457,   // 30 MIN + COACH (+10 min of mooring)
                        45: 12952179,   // 45 MIN + COACH (+10 min of mooring)
                        60: 12396432,   // 60 MIN + COACH (+10 min of mooring)
                        90: 12396453,   // 90 MIN + COACH (+10 min of mooring)
                        120: 12396454   // 120 MIN + COACH (+10 min of mooring)
                    }
                }
            }
        };

        // Price configuration
        const PRICES = {
            30: { base: 410, withTrainer: 567 },
            45: { base: 593, withTrainer: 830 },
            60: { base: 788, withTrainer: 1103 },
            90: { base: 1197, withTrainer: 1670 },
            120: { base: 1575, withTrainer: 2205 }
        };

        // Telegram Bot Configuration
        const TELEGRAM_BOT_TOKEN = 'YOUR_BOT_TOKEN_HERE';
        const TELEGRAM_CHAT_ID = 'YOUR_CHAT_ID_HERE';

        // Кэш для хранения ближайших доступных дат
        const availableDatesCache = new Map();
        
        // Глобальная переменная для хранения ближайших доступных дат
        let nearestAvailableDates = new Map();
        
        // Переменная для сохранения даты при смене услуги/локации
        let savedDate = null;

        // Получить ближайшие доступные слоты для локации
        async function getNearestAvailableSlots(locationKey, serviceId) {
            const cacheKey = `${locationKey}_${serviceId}`;
            
            // Проверяем кэш
            if (availableDatesCache.has(cacheKey)) {
                return availableDatesCache.get(cacheKey);
            }

            try {
                const staffId = API_CONFIG.locations[locationKey].staffId;
                const url = `http://localhost:3000/api/nearest-slots?companyId=${API_CONFIG.companyId}&staffId=${staffId}&serviceId=${serviceId}`;
                
                console.log('🔍 Получаем ближайшие слоты для:', { locationKey, serviceId, staffId });
                
                const response = await fetch(url);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('✅ Ближайшие слоты получены:', data);
                    
                    // Кэшируем результат
                    availableDatesCache.set(cacheKey, data);
                    return data;
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                console.error('❌ Ошибка получения ближайших слотов:', error);
                return null;
            }
        }

        // Проверить, нужно ли заблокировать дату (до ближайшего доступного слота)
        function isDateBeforeNearestAvailable(dateString) {
            const selectedLocation = getSelectedLocation();
            const selectedDuration = getSelectedDuration();
            const cacheKey = `${selectedLocation}_${selectedDuration}`;
            
            console.log(`🔍 [isDateBeforeNearestAvailable] Проверяем дату: ${dateString} для ${cacheKey}`);
            
            if (!nearestAvailableDates.has(cacheKey)) {
                console.log(`❌ [isDateBeforeNearestAvailable] Кэш для ${cacheKey} пуст. Не блокируем.`);
                return false; // Если нет данных, не блокируем
            }
            
            const nearestData = nearestAvailableDates.get(cacheKey);
            if (!nearestData || !nearestData.data || !nearestData.data.seance_date) {
                console.log(`❌ [isDateBeforeNearestAvailable] Нет данных о ближайшем слоте для ${cacheKey}. Не блокируем.`);
                return false;
            }
            
            // Извлекаем только дату из ISO строки (убираем время)
            const nearestDateStr = nearestData.data.seance_date.split('T')[0];
            const checkDateStr = dateString;
            
            console.log(`📅 [isDateBeforeNearestAvailable] Ближайшая доступная дата (из API): ${nearestDateStr}`);
            console.log(`📅 [isDateBeforeNearestAvailable] Проверяемая дата: ${checkDateStr}`);
            
            // Блокируем даты до ближайшего доступного слота (сравниваем строки дат)
            const shouldBlock = checkDateStr < nearestDateStr;
            console.log(`🚫 [isDateBeforeNearestAvailable] Результат блокировки: ${shouldBlock} (${checkDateStr} < ${nearestDateStr})`);
            
            return shouldBlock;
        }

        // Загрузить ближайшие доступные даты для всех локаций и услуг
        async function loadNearestAvailableDates() {
            console.log('🔄 [loadNearestAvailableDates] Начинаем загрузку ближайших доступных дат...');
            
            for (const locationKey of Object.keys(API_CONFIG.locations)) {
                console.log(`📍 [loadNearestAvailableDates] Обрабатываем локацию: ${locationKey}`);
                
                for (const duration of Object.keys(API_CONFIG.locations[locationKey].services)) {
                    const serviceId = API_CONFIG.locations[locationKey].services[duration];
                    const cacheKey = `${locationKey}_${duration}`;
                    
                    console.log(`⏱️ [loadNearestAvailableDates] Загружаем данные для ${locationKey} (${duration} мин, serviceId: ${serviceId})`);
                    
                    try {
                        const data = await getNearestAvailableSlots(locationKey, serviceId);
                        console.log(`📥 [loadNearestAvailableDates] Получены данные для ${cacheKey}:`, data);
                        
                        if (data && data.success) {
                            nearestAvailableDates.set(cacheKey, data);
                            console.log(`✅ [loadNearestAvailableDates] Сохранены ближайшие даты для ${locationKey} (${duration} мин): ${data.data.seance_date}`);
                        } else {
                            console.log(`❌ [loadNearestAvailableDates] Неуспешный ответ для ${cacheKey}:`, data);
                        }
                    } catch (error) {
                        console.error(`❌ [loadNearestAvailableDates] Ошибка загрузки ближайших дат для ${locationKey} (${duration} мин):`, error);
                    }
                }
            }
            
            console.log('✅ [loadNearestAvailableDates] Все ближайшие доступные даты загружены');
            console.log('📊 [loadNearestAvailableDates] Итоговый кэш:', Array.from(nearestAvailableDates.entries()));
        }

        // Load time slots from API
        async function loadTimeSlots() {
            const timeSlots = document.querySelector('.time-section .time-slots-grid');
            if (!timeSlots) return;
            
            // Показываем скелет анимацию
            timeSlots.innerHTML = `
                <div class="time-slot skeleton"></div>
                <div class="time-slot skeleton"></div>
                <div class="time-slot skeleton"></div>
                <div class="time-slot skeleton"></div>
                <div class="time-slot skeleton"></div>
                <div class="time-slot skeleton"></div>
            `;
            
            // Небольшая задержка для показа скелет анимации
            setTimeout(async () => {
                try {
                const selectedDuration = getSelectedDuration();
                const selectedLocation = getSelectedLocation();
                const selectedDate = getCurrentDate();
                
                console.log('🔍 Загружаем слоты:', {
                    duration: selectedDuration,
                    location: selectedLocation,
                    date: selectedDate
                });
                
                const serviceId = API_CONFIG.locations[selectedLocation].services[selectedDuration];
                const staffId = API_CONFIG.locations[selectedLocation].staffId;
                
                const url = `${API_CONFIG.proxyUrl}/api/slots?companyId=${API_CONFIG.companyId}&staffId=${staffId}&serviceId=${serviceId}&date=${selectedDate}`;
                
                const response = await fetch(url);
                
                if (response.ok) {
                    const data = await response.json();
                    displayTimeSlots(data);
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                } catch (error) {
                    console.error('Ошибка загрузки слотов:', error);
                    const timeSlots = document.querySelector('.time-section .time-slots-grid');
                    if (timeSlots) {
                        timeSlots.innerHTML = `<div class="error">Ошибка загрузки слотов: ${error.message}</div>`;
                    }
                }
            }, 50); // Минимальная задержка для показа скелетона
        }

        // Display time slots
        function displayTimeSlots(data) {
            const timeSlots = document.querySelector('.time-section .time-slots-grid');
            if (!timeSlots) return;
            
            timeSlots.innerHTML = '';
            
            if (data.success && data.data && Array.isArray(data.data) && data.data.length > 0) {
                data.data.forEach(slot => {
                    const slotElement = document.createElement('div');
                    slotElement.className = 'time-slot';
                    slotElement.textContent = slot.time;
                    slotElement.dataset.time = slot.time;
                    slotElement.dataset.datetime = slot.datetime;
                    
                    slotElement.addEventListener('click', function() {
                        document.querySelectorAll('.time-slot').forEach(s => s.classList.remove('selected'));
                        this.classList.add('selected');
                    });
                    
                    timeSlots.appendChild(slotElement);
                });
            } else {
                timeSlots.innerHTML = '<div class="error">Нет доступных слотов на сегодня</div>';
            }
        }

        // Helper functions
        function getSelectedDuration() {
            const selectedDuration = document.querySelector('.duration-option.selected');
            return parseInt(selectedDuration.dataset.duration);
        }

        function getSelectedLocation() {
            const selectedLocationBtn = document.querySelector('.location-btn.selected');
            return selectedLocationBtn.dataset.location;
        }

        function getServiceIdForLocation(locationKey) {
            const selectedDuration = getSelectedDuration();
            return API_CONFIG.locations[locationKey].services[selectedDuration];
        }

        function getStaffIdForLocation(locationKey) {
            return API_CONFIG.locations[locationKey].staffId;
        }

        // Calculate total price
        function calculateTotalPrice() {
            const duration = getSelectedDuration();
            const trainer = getSelectedTrainer();
            
            if (!PRICES[duration]) {
                return 0;
            }
            
            let price;
            if (trainer === 'with') {
                price = PRICES[duration].withTrainer;
            } else {
                price = PRICES[duration].base;
            }
            
            // Форматируем число с пробелами для тысяч
            return price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
        }

        // Update trainer price display
        function updateTrainerPrice() {
            const duration = getSelectedDuration();
            const trainerPriceElement = document.getElementById('trainerPrice');
            
            if (trainerPriceElement && PRICES[duration]) {
                const basePrice = PRICES[duration].base;
                const withTrainerPrice = PRICES[duration].withTrainer;
                const difference = withTrainerPrice - basePrice;
                
                // Форматируем число с пробелами для тысяч
                const formattedDifference = difference.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
                trainerPriceElement.textContent = `+${formattedDifference} AED`;
            }
        }

        // Popup functions
        function showPopup(type, title, message) {
            const overlay = document.getElementById('popupOverlay');
            const icon = document.getElementById('popupIcon');
            const titleEl = document.getElementById('popupTitle');
            const messageEl = document.getElementById('popupMessage');
            
            // Set content
            titleEl.textContent = title;
            messageEl.textContent = message;
            
            // Set icon and style
            if (type === 'success') {
                icon.textContent = '✓';
                icon.className = 'popup-icon success';
            } else {
                icon.textContent = '✕';
                icon.className = 'popup-icon error';
            }
            
            // Show popup
            overlay.classList.add('show');
        }

        function hidePopup() {
            const overlay = document.getElementById('popupOverlay');
            overlay.classList.remove('show');
        }

        function getSelectedTrainer() {
            const selectedTrainer = document.querySelector('.trainer-btn.selected');
            return selectedTrainer.dataset.trainer;
        }

        function getCurrentDate() {
            const selectedDateElement = document.querySelector('.calendar-date.selected');
            if (selectedDateElement && selectedDateElement.dataset.date) {
                return selectedDateElement.dataset.date;
            }
            const today = new Date();
            return today.toISOString().split('T')[0];
        }

        function getSelectedTimeSlot() {
            const selectedSlot = document.querySelector('.time-slot.selected');
            return selectedSlot ? selectedSlot.dataset.time : null;
        }

        // Send booking to Telegram
        async function sendToTelegram(bookingData) {
            const message = `
*Новая бронь WakeMe*

*Клиент:* ${bookingData.name}
*Телефон:* ${bookingData.phone}
*Локация:* ${bookingData.location}
*Длительность:* ${bookingData.duration} мин
*Тренер:* ${bookingData.trainer === 'with' ? 'С тренером' : 'Без тренера'}
*Время:* ${bookingData.time}
*Стоимость:* ${bookingData.total} AED
*Дата:* ${bookingData.date}
            `;

            try {
                const response = await fetch(`${API_CONFIG.proxyUrl}/api/send-telegram`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message
                    })
                });

                if (response.ok) {
                    return true;
                } else {
                    throw new Error('Ошибка отправки в Telegram');
                }
            } catch (error) {
                console.error('Ошибка отправки в Telegram:', error);
                return false;
            }
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Popup button handler
            document.getElementById('popupButton').addEventListener('click', hidePopup);
            document.getElementById('popupOverlay').addEventListener('click', function(e) {
                if (e.target === this) {
                    hidePopup();
                }
            });
            // Duration selection
            document.querySelectorAll('.duration-option').forEach(option => {
                option.addEventListener('click', function() {
                    console.log('⏱️ [DURATION] Переключение длительности');
                    
                    // Сохраняем текущую выбранную дату в глобальную переменную
                    const currentSelectedDate = document.querySelector('.calendar-date.selected');
                    savedDate = currentSelectedDate ? currentSelectedDate.dataset.date : null;
                    console.log('📅 [DURATION] Сохраняем дату в глобальную переменную:', savedDate);
                    
                    document.querySelectorAll('.duration-option').forEach(o => o.classList.remove('selected'));
                    this.classList.add('selected');
                    updateTrainerPrice(); // Обновляем цену тренера
                    clearAvailabilityCache(); // Очищаем кеш доступности при смене услуги
                    console.log('📅 [DURATION] Перерендериваем календарь');
                    renderCalendar(); // Обновляем календарь при изменении услуги
                    
                    // Ждем завершения рендеринга календаря, затем восстанавливаем дату
                    setTimeout(() => {
                        // Пытаемся восстановить сохраненную дату, если она доступна
                        if (savedDate) {
                            const dateElement = document.querySelector(`.calendar-date[data-date="${savedDate}"]`);
                            if (dateElement && !dateElement.classList.contains('disabled')) {
                                console.log('✅ [DURATION] Восстанавливаем сохраненную дату:', savedDate);
                                document.querySelectorAll('.calendar-date').forEach(d => d.classList.remove('selected'));
                                dateElement.classList.add('selected');
                                
                                // Ждем завершения выбора даты перед загрузкой слотов
                                waitForDateSelection().then(() => {
                                    console.log('⏰ [DURATION] Загружаем слоты времени');
                                    loadTimeSlots();
                                });
                            } else {
                                console.log('❌ [DURATION] Сохраненная дата недоступна, устанавливаем дефолтную');
                                setDefaultDate().then(() => {
                                    console.log('⏰ [DURATION] Загружаем слоты времени');
                                    loadTimeSlots();
                                });
                            }
                        } else {
                            console.log('🎯 [DURATION] Нет сохраненной даты, устанавливаем дефолтную');
                            setDefaultDate().then(() => {
                                console.log('⏰ [DURATION] Загружаем слоты времени');
                                loadTimeSlots();
                            });
                        }
                    }, 100); // Небольшая задержка для завершения рендеринга
                });
            });

            // Trainer selection
            document.querySelectorAll('.trainer-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.trainer-btn').forEach(b => b.classList.remove('selected'));
                    this.classList.add('selected');
                });
            });

            // Location selection
            document.querySelectorAll('.location-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    console.log('🔄 [LOCATION] Переключение локации');
                    
                    // Сохраняем текущую выбранную дату в глобальную переменную
                    const currentSelectedDate = document.querySelector('.calendar-date.selected');
                    savedDate = currentSelectedDate ? currentSelectedDate.dataset.date : null;
                    console.log('📅 [LOCATION] Сохраняем дату в глобальную переменную:', savedDate);
                    
                    document.querySelectorAll('.location-btn').forEach(b => b.classList.remove('selected'));
                    this.classList.add('selected');
                    clearAvailabilityCache(); // Очищаем кеш доступности при смене локации
                    console.log('📅 [LOCATION] Перерендериваем календарь');
                    renderCalendar(); // Обновляем календарь при изменении локации
                    
                    // Ждем завершения рендеринга календаря, затем восстанавливаем дату
                    setTimeout(() => {
                        // Пытаемся восстановить сохраненную дату, если она доступна
                        if (savedDate) {
                            const dateElement = document.querySelector(`.calendar-date[data-date="${savedDate}"]`);
                            if (dateElement && !dateElement.classList.contains('disabled')) {
                                console.log('✅ [LOCATION] Восстанавливаем сохраненную дату:', savedDate);
                                document.querySelectorAll('.calendar-date').forEach(d => d.classList.remove('selected'));
                                dateElement.classList.add('selected');
                                
                                // Ждем завершения выбора даты перед загрузкой слотов
                                waitForDateSelection().then(() => {
                                    console.log('⏰ [LOCATION] Загружаем слоты времени');
                                    loadTimeSlots();
                                });
                            } else {
                                console.log('❌ [LOCATION] Сохраненная дата недоступна, устанавливаем дефолтную');
                                setDefaultDate().then(() => {
                                    console.log('⏰ [LOCATION] Загружаем слоты времени');
                                    loadTimeSlots();
                                });
                            }
                        } else {
                            console.log('🎯 [LOCATION] Нет сохраненной даты, устанавливаем дефолтную');
                            setDefaultDate().then(() => {
                                console.log('⏰ [LOCATION] Загружаем слоты времени');
                                loadTimeSlots();
                            });
                        }
                    }, 200); // Увеличиваем задержку для полного завершения рендеринга
                });
            });


            // Booking form submission
            document.getElementById('bookingForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const selectedTime = getSelectedTimeSlot();
                if (!selectedTime) {
                    showPopup('error', 'Выберите время', 'Пожалуйста, выберите время для бронирования');
                    return;
                }

                const bookingData = {
                    name: document.getElementById('clientName').value,
                    phone: document.getElementById('clientPhone').value,
                    location: getSelectedLocation(),
                    duration: getSelectedDuration(),
                    trainer: getSelectedTrainer(),
                    time: selectedTime,
                    date: getCurrentDate(),
                    total: calculateTotalPrice()
                };

                const bookingBtn = document.getElementById('bookingBtn');
                bookingBtn.disabled = true;
                bookingBtn.textContent = 'Отправка...';

                try {
                    const success = await sendToTelegram(bookingData);
                    
                    if (success) {
                        showPopup('success', 'Заявка отправлена!', 'Мы свяжемся с вами в WhatsApp для подтверждения даты');
                        document.getElementById('bookingForm').reset();
                        document.querySelectorAll('.time-slot').forEach(s => s.classList.remove('selected'));
                    } else {
                        showPopup('error', 'Ошибка отправки', 'Не удалось отправить заявку. Попробуйте еще раз.');
                    }
                } catch (error) {
                    showPopup('error', 'Ошибка отправки', 'Не удалось отправить заявку. Попробуйте еще раз.');
                } finally {
                    bookingBtn.disabled = false;
                    bookingBtn.textContent = 'Забронировать';
                }
            });
        });

        // Calendar variables
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        
        // Cache for date availability
        let dateAvailabilityCache = new Map();
        
        // Clear availability cache when location or service changes
        function clearAvailabilityCache() {
            console.log('🧹 [clearAvailabilityCache] Очищаем кеш доступности дат');
            dateAvailabilityCache.clear();
        }
        
        // Check if slots are available for a specific date
        async function checkDateAvailability(dateString) {
            console.log(`🔍 [checkDateAvailability] Проверяем доступность для даты: ${dateString}`);
            
            // Check cache first
            if (dateAvailabilityCache.has(dateString)) {
                const cached = dateAvailabilityCache.get(dateString);
                console.log(`📋 [checkDateAvailability] Найдено в кеше: ${dateString} = ${cached}`);
                return cached;
            }
            
            try {
                const locationKey = getSelectedLocation();
                const serviceId = getServiceIdForLocation(locationKey);
                const staffId = getStaffIdForLocation(locationKey);
                const companyId = API_CONFIG.companyId;
                
                console.log(`📤 [checkDateAvailability] Запрос слотов для ${dateString}:`, {
                    locationKey, serviceId, staffId, companyId
                });
                
                const response = await fetch(`${API_CONFIG.proxyUrl}/api/slots?companyId=${companyId}&staffId=${staffId}&serviceId=${serviceId}&date=${dateString}`);
                
                if (!response.ok) {
                    console.log(`❌ [checkDateAvailability] Ошибка API для ${dateString}: ${response.status}`);
                    dateAvailabilityCache.set(dateString, false);
                    return false;
                }
                
                const data = await response.json();
                const hasSlots = data.success && data.data && data.data.length > 0;
                
                console.log(`📊 [checkDateAvailability] Результат для ${dateString}: ${hasSlots ? 'Есть слоты' : 'Нет слотов'}`);
                
                // Cache the result
                dateAvailabilityCache.set(dateString, hasSlots);
                return hasSlots;
                
            } catch (error) {
                console.error(`❌ [checkDateAvailability] Ошибка при проверке ${dateString}:`, error);
                dateAvailabilityCache.set(dateString, false);
                return false;
            }
        }

        // Calendar navigation
        function changeMonth(direction) {
            const today = new Date();
            const currentDate = new Date(currentYear, currentMonth);
            const todayDate = new Date(today.getFullYear(), today.getMonth());
            
            currentMonth += direction;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            } else if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            
            // Check if we're trying to go to a past month
            const newDate = new Date(currentYear, currentMonth);
            if (newDate < todayDate) {
                // Revert the change
                currentMonth -= direction;
                if (currentMonth < 0) {
                    currentMonth = 11;
                    currentYear--;
                } else if (currentMonth > 11) {
                    currentMonth = 0;
                    currentYear++;
                }
                return; // Don't render if we can't go to past month
            }
            
            renderCalendar();
        }

        // Render calendar
        function renderCalendar() {
            console.log('📅 [renderCalendar] Начинаем рендеринг календаря');
            console.log('🔍 [renderCalendar] Проверяем текущее состояние дат перед рендерингом:', {
                selectedDates: document.querySelectorAll('.calendar-date.selected').length,
                totalDates: document.querySelectorAll('.calendar-date').length
            });
            const calendarGrid = document.querySelector('.calendar-grid');
            const calendarMonthDisplay = document.querySelector('.calendar-month');
            
            if (!calendarGrid || !calendarMonthDisplay) {
                console.log('❌ [renderCalendar] Не найдены элементы календаря');
                return;
            }
            
            console.log('🧹 [renderCalendar] Очищаем календарь');
            calendarGrid.innerHTML = ''; // Очищаем перед показом скелета
            // Показываем скелет анимацию для календаря
            calendarGrid.innerHTML = `
                <div class="calendar-date skeleton"></div>
                <div class="calendar-date skeleton"></div>
                <div class="calendar-date skeleton"></div>
                <div class="calendar-date skeleton"></div>
                <div class="calendar-date skeleton"></div>
                <div class="calendar-date skeleton"></div>
                <div class="calendar-date skeleton"></div>
                <div class="calendar-date skeleton"></div>
                <div class="calendar-date skeleton"></div>
                <div class="calendar-date skeleton"></div>
                <div class="calendar-date skeleton"></div>
                <div class="calendar-date skeleton"></div>
                <div class="calendar-date skeleton"></div>
                <div class="calendar-date skeleton"></div>
                <div class="calendar-date skeleton"></div>
                <div class="calendar-date skeleton"></div>
                <div class="calendar-date skeleton"></div>
                <div class="calendar-date skeleton"></div>
                <div class="calendar-date skeleton"></div>
                <div class="calendar-date skeleton"></div>
                <div class="calendar-date skeleton"></div>
                <div class="calendar-date skeleton"></div>
                <div class="calendar-date skeleton"></div>
                <div class="calendar-date skeleton"></div>
                <div class="calendar-date skeleton"></div>
                <div class="calendar-date skeleton"></div>
                <div class="calendar-date skeleton"></div>
                <div class="calendar-date skeleton"></div>
                <div class="calendar-date skeleton"></div>
                <div class="calendar-date skeleton"></div>
                <div class="calendar-date skeleton"></div>
                <div class="calendar-date skeleton"></div>
                <div class="calendar-date skeleton"></div>
                <div class="calendar-date skeleton"></div>
                <div class="calendar-date skeleton"></div>
                <div class="calendar-date skeleton"></div>
            `;

            // Небольшая задержка для показа скелет анимации
            console.log('⏳ [renderCalendar] Показываем скелет анимацию сразу');
            // Минимальная задержка для показа скелетона
            setTimeout(() => {
                console.log('⏳ [renderCalendar] Начинаем рендеринг реальных дат');
                // Очищаем скелет перед рендерингом реальных дат
                calendarGrid.innerHTML = '';
                
                const firstDayOfMonth = new Date(currentYear, currentMonth, 1).getDay();
                const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

                calendarMonthDisplay.textContent = `${new Date(currentYear, currentMonth).toLocaleString('ru-RU', { month: 'long' })} ${currentYear}`;

                // Days of week
                const daysOfWeek = ['ПН', 'ВТ', 'СР', 'ЧТ', 'ПТ', 'СБ', 'ВС'];
                daysOfWeek.forEach(day => {
                    const dayElement = document.createElement('div');
                    dayElement.className = 'calendar-day';
                    dayElement.textContent = day;
                    calendarGrid.appendChild(dayElement);
                });

                // Adjust first day to be Monday (0 for Sunday, 1 for Monday, etc.)
                let startDay = firstDayOfMonth === 0 ? 6 : firstDayOfMonth - 1;

                // Add empty divs for days before the 1st
                for (let i = 0; i < startDay; i++) {
                    const emptyDate = document.createElement('div');
                    emptyDate.className = 'calendar-date other-month';
                    const prevMonthDays = new Date(currentYear, currentMonth, 0).getDate();
                    emptyDate.textContent = prevMonthDays - startDay + i + 1;
                    calendarGrid.appendChild(emptyDate);
                }

                // Add days of the current month
                for (let i = 1; i <= daysInMonth; i++) {
                    const dateElement = document.createElement('div');
                    const cellDate = new Date(currentYear, currentMonth, i);
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    const isPastDate = cellDate < today;
                
                    dateElement.className = 'calendar-date';
                    dateElement.textContent = i;
                    dateElement.dataset.date = `${currentYear}-${(currentMonth + 1).toString().padStart(2, '0')}-${i.toString().padStart(2, '0')}`;
                    
                    // Проверяем, нужно ли заблокировать дату
                    const dateString = dateElement.dataset.date;
                    const isBeforeNearest = isDateBeforeNearestAvailable(dateString);
                    const shouldDisable = isPastDate || isBeforeNearest;
                    
                    console.log(`📅 [renderCalendar] Дата ${dateString}: прошлая=${isPastDate}, до ближайшего=${isBeforeNearest}, блокировать=${shouldDisable}`);
                    
                    if (shouldDisable) {
                        dateElement.classList.add('disabled');
                        dateElement.style.opacity = '0.3';
                        dateElement.style.cursor = 'not-allowed';
                        console.log(`🚫 [renderCalendar] Заблокирована дата: ${dateString}`);
                    } else {
                        // Check availability for non-disabled dates
                        checkDateAvailability(dateString).then(hasSlots => {
                            if (!hasSlots) {
                                dateElement.classList.add('no-slots');
                                console.log(`🚫 [renderCalendar] Нет слотов для даты: ${dateString}`);
                            }
                        });
                        
                        // НЕ выделяем сегодняшнюю дату автоматически - это будет сделано после загрузки данных о доступности
                        // const hasSelectedDate = document.querySelector('.calendar-date.selected');
                        // if (i === today.getDate() && currentMonth === today.getMonth() && currentYear === today.getFullYear() && !hasSelectedDate) {
                        //     dateElement.classList.add('selected');
                        // }

                        dateElement.addEventListener('click', function() {
                            // Don't allow clicking on dates without slots
                            if (this.classList.contains('no-slots')) {
                                console.log(`🚫 [renderCalendar] Попытка клика на дату без слотов: ${dateString}`);
                                return;
                            }
                            
                            console.log(`🖱️ [renderCalendar] Клик по дате: ${dateString}`);
                            document.querySelectorAll('.calendar-date').forEach(d => d.classList.remove('selected'));
                            this.classList.add('selected');
                            loadTimeSlots();
                        });
                    }
                    
                    calendarGrid.appendChild(dateElement);
                }
            
                console.log('✅ [renderCalendar] Календарь отрендерен');
                console.log('📊 [renderCalendar] Статистика календаря:', {
                    totalDates: document.querySelectorAll('.calendar-date').length,
                    disabledDates: document.querySelectorAll('.calendar-date.disabled').length,
                    selectedDates: document.querySelectorAll('.calendar-date.selected').length,
                    availableDates: document.querySelectorAll('.calendar-date:not(.disabled)').length
                });
                
                // НЕ устанавливаем дефолтную дату здесь - это делается в инициализации
                console.log('📅 [renderCalendar] Календарь отрендерен, дата будет установлена отдельно');
            }, 50); // Минимальная задержка для показа скелетона
        }

        function setDefaultSelections() {
            console.log('⚙️ [setDefaultSelections] Начинаем установку дефолтных значений');
            
            // Сначала убираем все выделения
            console.log('🧹 [setDefaultSelections] Убираем все выделения');
            document.querySelectorAll('.duration-option').forEach(option => {
                option.classList.remove('selected');
            });
            document.querySelectorAll('.trainer-btn').forEach(btn => {
                btn.classList.remove('selected');
            });

            // Выбираем 60 минут по умолчанию
            const duration60 = document.querySelector('.duration-option[data-duration="60"]');
            if (duration60) {
                duration60.classList.add('selected');
                console.log('✅ [setDefaultSelections] Выбрана длительность: 60 минут');
            } else {
                console.log('❌ [setDefaultSelections] Не найдена опция 60 минут');
            }

            // Выбираем "с тренером" по умолчанию
            const withTrainer = document.querySelector('.trainer-btn[data-trainer="with"]');
            if (withTrainer) {
                withTrainer.classList.add('selected');
                console.log('✅ [setDefaultSelections] Выбран тренер: с тренером');
            } else {
                console.log('❌ [setDefaultSelections] Не найдена опция "с тренером"');
            }

            // Обновляем цену тренера для выбранной услуги
            updateTrainerPrice();
            
            // НЕ устанавливаем дату здесь - она будет установлена после загрузки данных о доступности
            console.log('📅 [setDefaultSelections] Пропускаем установку даты - будет установлена после загрузки данных');
        }

        // Установить дефолтную дату (ближайшую доступную)
        function setDefaultDate() {
            return new Promise((resolve) => {
            console.log('🎯 [setDefaultDate] ВЫЗОВ setDefaultDate - стек вызовов:', new Error().stack);
            sendLogToServer('SET_DEFAULT_DATE', 'Вызов setDefaultDate', {
                stack: new Error().stack.split('\n').slice(0, 5)
            });
            const selectedLocation = getSelectedLocation();
            const selectedDuration = getSelectedDuration();
            const cacheKey = `${selectedLocation}_${selectedDuration}`;
            
            console.log(`🎯 [setDefaultDate] Начинаем установку дефолтной даты для ${cacheKey}`);
            sendLogToServer('SET_DEFAULT_DATE', `Начинаем установку дефолтной даты для ${cacheKey}`);
            
            let defaultDate = null;
            
            // Если есть данные о ближайших датах, используем их
            if (nearestAvailableDates.has(cacheKey)) {
                const nearestData = nearestAvailableDates.get(cacheKey);
                console.log(`📊 [setDefaultDate] Данные о ближайших датах для ${cacheKey}:`, nearestData);
                
                if (nearestData && nearestData.data && nearestData.data.seance_date) {
                    const nearestDateStr = nearestData.data.seance_date.split('T')[0];
                    defaultDate = nearestDateStr;
                    console.log(`📅 [setDefaultDate] Используем ближайшую доступную дату: ${defaultDate}`);
                } else {
                    console.log(`❌ [setDefaultDate] Нет данных о ближайшей дате в кэше для ${cacheKey}`);
                }
            } else {
                console.log(`❌ [setDefaultDate] Кэш пуст для ${cacheKey}, используем сегодняшнюю дату`);
                // Fallback на сегодняшнюю дату, если кэш пуст
                const today = new Date();
                defaultDate = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getDate().toString().padStart(2, '0')}`;
            }
            
            if (!defaultDate) {
                console.log(`❌ [setDefaultDate] Не удалось определить дефолтную дату`);
                resolve();
                return;
            }
            
            // Находим и выделяем элемент календаря
            const dateElement = document.querySelector(`.calendar-date[data-date="${defaultDate}"]`);
            console.log(`🔍 [setDefaultDate] Ищем элемент календаря для даты ${defaultDate}:`, dateElement);
            
            if (dateElement) {
                console.log(`📋 [setDefaultDate] Элемент найден, заблокирован: ${dateElement.classList.contains('disabled')}`);
                
                if (!dateElement.classList.contains('disabled')) {
                    // Убираем выделение с других дат
                    document.querySelectorAll('.calendar-date').forEach(d => d.classList.remove('selected'));
                    dateElement.classList.add('selected');
                    console.log(`✅ [setDefaultDate] Установлена дефолтная дата: ${defaultDate}`);
                    resolve();
                } else {
                    console.log(`❌ [setDefaultDate] Элемент для даты ${defaultDate} заблокирован, ищем следующую доступную дату`);
                    
                    // Ищем следующую доступную дату
                    const allDates = Array.from(document.querySelectorAll('.calendar-date:not(.disabled)'));
                    const sortedDates = allDates
                        .map(el => ({ element: el, date: el.dataset.date }))
                        .filter(item => item.date >= defaultDate)
                        .sort((a, b) => a.date.localeCompare(b.date));
                    
                    if (sortedDates.length > 0) {
                        const nextAvailableDate = sortedDates[0];
                        nextAvailableDate.element.classList.add('selected');
                        console.log(`✅ [setDefaultDate] Найдена следующая доступная дата: ${nextAvailableDate.date}`);
                    } else {
                        console.log(`❌ [setDefaultDate] Не найдено доступных дат после ${defaultDate}`);
                    }
                    resolve();
                }
            } else {
                console.log(`❌ [setDefaultDate] Элемент календаря для даты ${defaultDate} не найден`);
                resolve();
            }
            
            // Финальная проверка выбранной даты
            const finalSelectedDate = document.querySelector('.calendar-date.selected');
            if (finalSelectedDate) {
                console.log(`🎉 [setDefaultDate] ФИНАЛЬНАЯ ВЫБРАННАЯ ДАТА: ${finalSelectedDate.dataset.date}`);
            } else {
                console.log(`❌ [setDefaultDate] ПРОБЛЕМА: Ни одна дата не выбрана!`);
                console.log('🔍 [setDefaultDate] Доступные даты:', Array.from(document.querySelectorAll('.calendar-date:not(.disabled)')).map(el => el.dataset.date));
                console.log('🔍 [setDefaultDate] Все даты:', Array.from(document.querySelectorAll('.calendar-date')).map(el => ({
                    date: el.dataset.date,
                    disabled: el.classList.contains('disabled'),
                    selected: el.classList.contains('selected')
                })));
            }
            });
        }

        // Ждать завершения выбора даты
        function waitForDateSelection() {
            return new Promise((resolve) => {
                let attempts = 0;
                const maxAttempts = 100; // 5 секунд максимум
                
                const checkDateSelection = () => {
                    attempts++;
                    const selectedDate = document.querySelector('.calendar-date.selected');
                    const allDates = document.querySelectorAll('.calendar-date');
                    const availableDates = document.querySelectorAll('.calendar-date:not(.disabled)');
                    
                    console.log(`⏳ [waitForDateSelection] Попытка ${attempts}/${maxAttempts}:`, {
                        selectedDate: selectedDate ? selectedDate.dataset.date : 'НЕТ',
                        totalDates: allDates.length,
                        availableDates: availableDates.length,
                        disabledDates: document.querySelectorAll('.calendar-date.disabled').length
                    });
                    
                    if (selectedDate) {
                        console.log('✅ [waitForDateSelection] Дата выбрана:', selectedDate.dataset.date);
                        resolve();
                    } else if (attempts >= maxAttempts) {
                        console.log('❌ [waitForDateSelection] Таймаут! Принудительно продолжаем');
                        resolve();
                    } else {
                        setTimeout(checkDateSelection, 50);
                    }
                };
                checkDateSelection();
            });
        }

        // Отправка логов на сервер
        function sendLogToServer(level, message, data = {}) {
            const logData = {
                level: level,
                message: message,
                data: data,
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent,
                url: window.location.href
            };
            
            // Отправляем на сервер
            fetch('https://wakeme-booking-api-production.up.railway.app/api/logs', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(logData)
            }).catch(err => {
                console.log('❌ [LOGS] Ошибка отправки лога:', err);
            });
            
            // Также выводим в консоль
            console.log(`📝 [${level}] ${message}`, data);
        }

        // Мониторинг изменений дат
        function startDateMonitoring() {
            let lastSelectedDate = null;
            
            // Создаем визуальный индикатор для мобильных устройств
            const debugPanel = document.createElement('div');
            debugPanel.id = 'debug-panel';
            debugPanel.style.cssText = `
                position: fixed;
                top: 10px;
                right: 10px;
                background: rgba(0,0,0,0.8);
                color: white;
                padding: 10px;
                border-radius: 5px;
                font-size: 12px;
                z-index: 9999;
                max-width: 200px;
                font-family: monospace;
            `;
            document.body.appendChild(debugPanel);
            
            setInterval(() => {
                const currentSelectedDate = document.querySelector('.calendar-date.selected');
                const currentDate = currentSelectedDate ? currentSelectedDate.dataset.date : null;
                const availableDates = document.querySelectorAll('.calendar-date:not(.disabled)').length;
                const totalDates = document.querySelectorAll('.calendar-date').length;
                
                if (currentDate !== lastSelectedDate) {
                    const logData = {
                        from: lastSelectedDate,
                        to: currentDate,
                        availableDates: availableDates,
                        totalDates: totalDates
                    };
                    
                    sendLogToServer('DATE_CHANGE', 'Изменение выбранной даты', logData);
                    lastSelectedDate = currentDate;
                }
                
                // Обновляем визуальный индикатор
                debugPanel.innerHTML = `
                    <div>📅 Дата: ${currentDate || 'НЕТ'}</div>
                    <div>📊 Доступно: ${availableDates}/${totalDates}</div>
                    <div>⏰ ${new Date().toLocaleTimeString()}</div>
                `;
            }, 100);
        }

        // Initialize
        console.log('🚀 [INIT] Начинаем инициализацию формы');
        sendLogToServer('INIT', 'Начинаем инициализацию формы');
        setDefaultSelections();
        startDateMonitoring();
        
        // НОВАЯ ЛОГИКА: Сначала загружаем данные, потом рендерим календарь, потом устанавливаем дату
        console.log('🔄 [INIT] Загружаем ближайшие доступные даты...');
        loadNearestAvailableDates().then(() => {
            console.log('✅ [INIT] Ближайшие даты загружены');
            sendLogToServer('INIT', 'Ближайшие даты загружены');
            
            // Рендерим календарь БЕЗ установки даты
            console.log('📅 [INIT] Рендерим календарь');
            renderCalendar();
            
            // Ждем завершения рендеринга календаря
            setTimeout(() => {
                console.log('🎯 [INIT] Устанавливаем дефолтную дату');
                sendLogToServer('INIT', 'Устанавливаем дефолтную дату');
                
                // Устанавливаем дефолтную дату
                setDefaultDate().then(() => {
                    console.log('✅ [INIT] Дефолтная дата установлена');
                    sendLogToServer('INIT', 'Дефолтная дата установлена');
                    
                    // Только ПОСЛЕ установки даты загружаем слоты
                    console.log('⏰ [INIT] Загружаем слоты времени');
                    loadTimeSlots();
                    console.log('🏁 [INIT] Инициализация завершена');
                    sendLogToServer('INIT', 'Инициализация завершена');
                });
            }, 500); // Увеличиваем задержку для стабильности
        });
    </script>
</body>
</html>