<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WakeMe - –û–Ω–ª–∞–π–Ω –∑–∞–ø–∏—Å—å</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Unbounded:wght@200;300;400;500;600;700;800;900&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            margin: 0;
            padding: 0;
            outline: none;
            border: none;
        }

        body {
            font-family: 'Unbounded', sans-serif;
            background: white;
            min-height: 100vh;
            margin: 0;
            padding: 0;
            outline: none;
            border: none;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 40px;
        }

        .location-section {
            grid-column: 1;
        }

        .calendar-section {
            grid-column: 2;
        }

        .service-section {
            grid-column: 3;
        }

        .time-section {
            grid-column: 4;
            padding-top: 10px;
        }

        .section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 16px;
            transition: all 0.2s ease;
        }


        .location-options {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .location-btn {
            padding: 12px 16px;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: left;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .location-btn:hover {
            background: rgba(100, 215, 242, 0.05);
        }

        .location-btn.selected {
            background: #64D7F2;
            color: white;
        }

        .location-btn.selected .location-name {
            color: white;
        }

        .location-btn.selected .feature-item {
            color: rgba(255, 255, 255, 0.9);
        }

        .location-name {
            font-family: 'Unbounded', sans-serif;
            font-size: 12px;
            font-weight: 500;
            color: #2c2c2c;
            margin-bottom: 4px;
        }

        .location-address {
            font-family: 'Unbounded', sans-serif;
            font-size: 11px;
            font-weight: 300;
            color: #666;
        }

        .location-features {
            margin-top: 8px;
        }

        .feature-item {
            font-family: 'Unbounded', sans-serif;
            font-size: 9px;
            font-weight: 300;
            color: #666;
            line-height: 1.4;
            margin-bottom: 2px;
        }

        .feature-item:last-child {
            margin-bottom: 0;
        }

        .feature-item em {
            font-style: italic;
        }

        .location-map {
            width: 100%;
            height: 200px;
            background: #f8f9fa;
            border-radius: 12px;
            margin-top: 16px;
            position: relative;
            overflow: hidden;
            border: 1px solid #e9ecef;
        }

        .map-pin {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            background: #ff4444;
            border-radius: 50% 50% 50% 0;
            transform: translate(-50%, -50%) rotate(-45deg);
        }

        .map-pin::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(45deg);
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
        }

        .map-fullscreen {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #ddd;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
            color: #666;
        }

        .duration-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .duration-option {
            padding: 10px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            background: white;
        }

        .duration-option:hover {
            background: rgba(100, 215, 242, 0.05);
        }

        .duration-option.selected {
            background: #64D7F2;
            color: white;
        }

        .duration-option.selected .duration-price {
            color: rgba(255, 255, 255, 0.9);
        }

        .duration-option.selected .duration-time {
            color: white;
        }

        .duration-time {
            font-size: 14px;
            font-weight: 500;
            color: #2c2c2c;
            margin-bottom: 2px;
        }

        .duration-price {
            font-size: 12px;
            font-weight: 500;
            color: #999;
        }

        .section-divider {
            height: 1px;
            background: #e9ecef;
            margin: 16px 0;
        }

        .trainer-options {
            display: flex;
            flex-direction: row;
            gap: 8px;
            width: 100%;
        }

        .trainer-btn {
            font-family: 'Unbounded', sans-serif;
            padding: 12px 16px;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            font-size: 12px;
            font-weight: 400;
            margin-bottom: 4px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1;
            width: 100%;
            min-height: 60px;
        }

        .trainer-btn:hover {
            background: rgba(100, 215, 242, 0.05);
        }

        .trainer-btn.selected {
            background: #64D7F2;
            color: white;
        }

        .trainer-price {
            font-size: 12px;
            font-weight: 500;
            color: #999;
            margin-top: 2px;
        }

        .trainer-btn.selected .trainer-price {
            color: rgba(255, 255, 255, 0.8);
        }


        .booking-form {
            background: #f8f9fa;
            border-radius: 16px;
            padding: 30px;
            margin-top: -20px;
        }

        .form-header {
            text-align: left;
            margin-bottom: 20px;
        }

        .form-title {
            font-family: 'Unbounded', sans-serif;
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 12px;
        }

        .form-description {
            font-family: 'Unbounded', sans-serif;
            font-size: 12px;
            font-weight: 400;
            color: #666;
            margin-bottom: 24px;
        }

        /* Popup Styles */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .popup-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .popup {
            background: white;
            border-radius: 16px;
            padding: 32px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .popup-overlay.show .popup {
            transform: scale(1);
        }

        .popup-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
        }

        .popup-icon.success {
            background: #d4edda;
            color: #155724;
        }

        .popup-icon.error {
            background: #f8d7da;
            color: #721c24;
        }

        .popup-title {
            font-family: 'Unbounded', sans-serif;
            font-size: 20px;
            font-weight: 600;
            color: #333;
            margin-bottom: 12px;
        }

        .popup-message {
            font-family: 'Unbounded', sans-serif;
            font-size: 14px;
            font-weight: 400;
            color: #666;
            margin-bottom: 24px;
            line-height: 1.5;
        }

        .popup-button {
            font-family: 'Unbounded', sans-serif;
            background: #64D7F2;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .popup-button:hover {
            background: #4BC5E8;
        }

        .booking-form form {
            display: flex;
            gap: 8px;
            align-items: center;
            width: 100%;
            align-items: stretch;
        }

        .form-group {
            flex: 0.8;
            margin-bottom: 0;
            display: flex;
            align-items: center;
        }

        .booking-btn {
            flex-shrink: 0;
            width: 250px;
            height: 48px;
            padding: 0 32px;
            margin: 0;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
        }



        .form-group {
            margin-bottom: 20px;
        }


        .form-input {
            font-family: 'Unbounded', sans-serif;
            width: 100%;
            padding: 0 16px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 400;
            transition: all 0.2s;
            background: white;
            height: 48px;
            margin: 0;
            box-sizing: border-box;
        }

        .form-input:focus {
            outline: none;
            background: white;
        }

        .form-input::placeholder {
            font-size: 12px;
            font-weight: 300;
            color: #999;
        }

        .booking-btn {
            font-family: 'Unbounded', sans-serif;
            background: #64D7F2;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 400;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .booking-btn:hover {
            background: #4BC5E8;
        }

        .booking-btn:focus {
            outline: none;
        }

        /* –£–±–∏—Ä–∞–µ–º –æ–±–≤–æ–¥–∫–∏ —Å–æ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫ –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ */
        button:focus {
            outline: none;
        }

        /* –£–±–∏—Ä–∞–µ–º –≤—Å–µ –æ–±–≤–æ–¥–∫–∏ —Å input –∏ button */
        input, button {
            border: none !important;
            outline: none !important;
        }

        .booking-form * {
            box-sizing: border-box;
        }

        .booking-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .time-slots-section {
            margin-top: 20px;
        }

        .time-slots-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 8px;
            margin-top: 16px;
        }

        .time-slot {
            padding: 12px 8px;
            border-radius: 6px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            font-weight: 500;
            background: white;
        }

        .time-slot:hover {
            background: rgba(100, 215, 242, 0.05);
        }

        .time-slot.selected {
            background: #64D7F2;
            color: white;
        }

        .time-slot.unavailable {
            background: #f5f5f5;
            color: #ccc;
            cursor: not-allowed;
        }

        /* Skeleton loading animation */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
            border-radius: 8px;
        }

        @keyframes skeleton-loading {
            0% {
                background-position: 200% 0;
            }
            100% {
                background-position: -200% 0;
            }
        }

        .time-slot.skeleton {
            height: 48px;
            margin-bottom: 8px;
        }

        .calendar-date.skeleton {
            height: 32px;
            width: 32px;
            border-radius: 50%;
        }

        .total-info {
            background: rgba(100, 215, 242, 0.05);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
            text-align: center;
        }

        .total-amount {
            font-size: 24px;
            font-weight: 700;
            color: #64D7F2;
            margin-bottom: 4px;
        }

        .total-details {
            font-size: 14px;
            color: #666;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .error {
            text-align: center;
            padding: 20px;
            color: #ff4444;
            background: #fff5f5;
            border-radius: 8px;
        }

        .form-error {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 40px 20px;
            background: transparent;
            border: none;
            border-radius: 0;
            width: 100%;
            height: 100%;
            min-height: 200px;
        }

        .form-error-icon {
            font-size: 32px;
            margin-bottom: 16px;
            text-align: center;
        }

        .form-error-title {
            font-family: 'Unbounded', sans-serif;
            font-size: 11px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            text-align: center;
        }

        .form-error-description {
            font-family: 'Unbounded', sans-serif;
            font-size: 10px;
            font-weight: 400;
            color: #666;
            text-align: center;
        }

        /* Calendar Styles */

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .calendar-nav {
            background: #f8f9fa;
            border-radius: 4px;
            width: 28px;
            height: 28px;
            color: #666;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .calendar-nav:hover {
            background: #64D7F2;
            color: white;
        }

        .calendar-month {
            font-size: 14px;
            font-weight: 500;
            color: #2c2c2c;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }

        .calendar-day {
            text-align: center;
            padding: 6px 2px;
            font-size: 11px;
            color: #999;
            font-weight: 500;
        }

        .calendar-date {
            text-align: center;
            padding: 6px 2px;
            font-size: 12px;
            color: #2c2c2c;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s ease;
            font-weight: 400;
        }

        .calendar-date:hover {
            background: rgba(100, 215, 242, 0.1);
        }

        .calendar-date.selected {
            background: #64D7F2;
            color: white;
        }

        .calendar-date.disabled {
            opacity: 0.3;
            cursor: not-allowed;
            color: #999;
            background: transparent;
        }

        .calendar-date.disabled:hover {
            background: transparent;
        }

        .calendar-date.no-slots {
            color: #999;
            opacity: 0.5;
            cursor: not-allowed;
            background: #f5f5f5;
        }

        .calendar-date.no-slots:hover {
            background: #f5f5f5;
        }

        .calendar-date.other-month {
            color: #999;
            cursor: not-allowed;
            opacity: 0.3;
        }

        .calendar-date.other-month:hover {
            background: transparent;
            transform: none;
        }

        /* Mobile styles */
        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr 1fr;
                gap: 20px;
            }

            .location-section {
                grid-column: 1;
            }

            .calendar-section {
                grid-column: 2;
            }

            .service-section {
                grid-column: 1;
            }

            .time-section {
                grid-column: 2;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 0 5%;
                max-width: 90%;
            }
            
            .main-content {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .location-section,
            .calendar-section,
            .service-section,
            .time-section {
                grid-column: 1;
            }
            
            /* –°–µ–∫—Ü–∏—è –≤—Ä–µ–º–µ–Ω–∏ —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç —Å —Ä–µ–∞–ª—å–Ω—ã–º API */

            .duration-options {
                grid-template-columns: 1fr 1fr;
            }

            .time-slots-grid {
                grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            }

            .booking-form form {
                flex-direction: column;
                gap: 16px;
                align-items: center;
            }

            .form-group {
                margin-bottom: 16px;
                min-width: auto;
                width: 100%;
            }

            .booking-btn {
                min-width: auto;
                width: 100%;
                max-width: 300px;
            }
        }

        /* Extra small screens */
        @media (max-width: 480px) {
            .container {
                padding: 0 2%;
                max-width: 95%;
            }
            
            .duration-options {
                grid-template-columns: 1fr 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Main Content -->
        <div class="main-content">
            <!-- Location Selection -->
            <div class="section location-section">
                <div class="location-options">
                    <button class="location-btn selected" data-location="DUBAI_HARBOUR_MARINA">
                        <div class="location-name">Marina Harbour</div>
                        <div class="location-features">
                            <div class="feature-item">‚Ä¢ —É–¥–æ–±–Ω–æ–µ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –≤ —Ü–µ–Ω—Ç—Ä–µ –≥–æ—Ä–æ–¥–∞</div>
                            <div class="feature-item">‚Ä¢ –≤–∏–¥ –Ω–∞ –∫–æ–ª–µ—Å–æ –æ–±–æ–∑—Ä–µ–Ω–∏—è Ain Dubai, JBR –∏ Address Beach Residences</div>
                            <div class="feature-item">‚Ä¢ –∫—Ä–∏—Å—Ç–∞–ª—å–Ω–æ-–≥–æ–ª—É–±–∞—è –≤–æ–¥–∞</div>
                        </div>
                    </button>
                    <button class="location-btn" data-location="DUBAI_CREEK_HARBOUR">
                        <div class="location-name">Creek Harbour</div>
                        <div class="location-features">
                            <div class="feature-item">‚Ä¢ –ª–æ–∫–∞—Ü–∏—è –±–µ–∑ —Å—Ç–æ—Ä–æ–Ω–Ω–∏—Ö –≤–æ–ª–Ω</div>
                            <div class="feature-item">‚Ä¢ –∑–∞–∫–∞—Ç —Å –≤–∏–¥–æ–º –Ω–∞ <em>Burj Khalifa</em></div>
                            <div class="feature-item">‚Ä¢ –Ω–µ—Ç <em>Jet Ski</em></div>
                        </div>
                    </button>
                </div>
            </div>

            <!-- Calendar Section -->
            <div class="section calendar-section">
                <div class="calendar-header">
                    <button class="calendar-nav" onclick="changeMonth(-1)">‚Äπ</button>
                    <div class="calendar-month">–û–∫—Ç—è–±—Ä—å 2025</div>
                    <button class="calendar-nav" onclick="changeMonth(1)">‚Ä∫</button>
                </div>
                <div class="calendar-grid">
                    <!-- Calendar days and dates will be dynamically generated by JS -->
                </div>
            </div>

            <!-- Service & Trainer Selection -->
            <div class="section service-section">
                <div class="duration-options">
                    <div class="duration-option" data-duration="30">
                        <div class="duration-time">30 –º–∏–Ω</div>
                        <div class="duration-price">410 AED</div>
                    </div>
                    <div class="duration-option" data-duration="45">
                        <div class="duration-time">45 –º–∏–Ω</div>
                        <div class="duration-price">593 AED</div>
                    </div>
                    <div class="duration-option" data-duration="60">
                        <div class="duration-time">60 –º–∏–Ω</div>
                        <div class="duration-price">788 AED</div>
                    </div>
                    <div class="duration-option" data-duration="90">
                        <div class="duration-time">90 –º–∏–Ω</div>
                        <div class="duration-price">1 197 AED</div>
                    </div>
                    <div class="duration-option" data-duration="120">
                        <div class="duration-time">120 –º–∏–Ω</div>
                        <div class="duration-price">1 575 AED</div>
                    </div>
                </div>
                
                <div class="section-divider"></div>
                
                <div class="trainer-options">
                    <button class="trainer-btn" data-trainer="with">
                        <span>–° —Ç—Ä–µ–Ω–µ—Ä–æ–º</span>
                        <span class="trainer-price" id="trainerPrice">+COACH</span>
                    </button>
                    <button class="trainer-btn" data-trainer="without">
                        <span>–ë–µ–∑ —Ç—Ä–µ–Ω–µ—Ä–∞</span>
                    </button>
                </div>
            </div>

            <!-- Time Selection -->
            <div class="section time-section">
                <div class="time-slots-grid" id="timeSlots">
                    <div class="time-slot skeleton"></div>
                    <div class="time-slot skeleton"></div>
                    <div class="time-slot skeleton"></div>
                    <div class="time-slot skeleton"></div>
                    <div class="time-slot skeleton"></div>
                    <div class="time-slot skeleton"></div>
                </div>
            </div>
        </div>


        <!-- Booking Form -->
        <div class="booking-form">
            <div class="form-header">
                <div class="form-title">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É</div>
                <div class="form-description">–ú—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –≤ WhatsApp –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –¥–∞—Ç—ã</div>
            </div>
            <form id="bookingForm">
                <div class="form-group">
                    <input type="text" id="clientName" class="form-input" required placeholder="–ò–º—è">
                </div>
                
                <div class="form-group">
                    <input type="tel" id="clientPhone" class="form-input" required placeholder="–¢–µ–ª–µ—Ñ–æ–Ω">
                </div>
                
                <button type="submit" class="booking-btn" id="bookingBtn">
                    –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å
                </button>
            </form>
        </div>
    </div>

    <!-- Popup -->
    <div class="popup-overlay" id="popupOverlay">
        <div class="popup">
            <div class="popup-icon" id="popupIcon"></div>
            <div class="popup-title" id="popupTitle"></div>
            <div class="popup-message" id="popupMessage"></div>
            <button class="popup-button" id="popupButton">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
        </div>
    </div>

    <script>
        // API Configuration
        const API_CONFIG = {
            proxyUrl: 'https://wakeme-booking-api-production.up.railway.app',
            companyId: 1252189,
            locations: {
                'DUBAI_HARBOUR_MARINA': {
                    staffId: 2742288,
                    services: {
                        30: 12199769,   // 30 MIN (+20 min of mooring)
                        45: 12952120,   // 45 MIN (+20 min of mooring)
                        60: 12200654,   // 60 MIN (+20 min of mooring)
                        90: 12200653,   // 90 MIN (+20 min of mooring)
                        120: 12203754   // 120 MIN (+20 min of mooring)
                    }
                },
                'DUBAI_CREEK_HARBOUR': {
                    staffId: 2780637,
                    services: {
                        30: 12396457,   // 30 MIN + COACH (+10 min of mooring)
                        45: 12952179,   // 45 MIN + COACH (+10 min of mooring)
                        60: 12396432,   // 60 MIN + COACH (+10 min of mooring)
                        90: 12396453,   // 90 MIN + COACH (+10 min of mooring)
                        120: 12396454   // 120 MIN + COACH (+10 min of mooring)
                    }
                }
            }
        };

        // Price configuration
        const PRICES = {
            30: { base: 410, withTrainer: 567 },
            45: { base: 593, withTrainer: 830 },
            60: { base: 788, withTrainer: 1103 },
            90: { base: 1197, withTrainer: 1670 },
            120: { base: 1575, withTrainer: 2205 }
        };

        // Telegram Bot Configuration
        const TELEGRAM_BOT_TOKEN = 'YOUR_BOT_TOKEN_HERE';
        const TELEGRAM_CHAT_ID = 'YOUR_CHAT_ID_HERE';

        // –ö—ç—à –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –±–ª–∏–∂–∞–π—à–∏—Ö –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–∞—Ç
        const availableDatesCache = new Map();
        
        // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –±–ª–∏–∂–∞–π—à–∏—Ö –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–∞—Ç
        let nearestAvailableDates = new Map();
        
        // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞—Ç—ã –ø—Ä–∏ —Å–º–µ–Ω–µ —É—Å–ª—É–≥–∏/–ª–æ–∫–∞—Ü–∏–∏
        let savedDate = null;

        // –ü–æ–ª—É—á–∏—Ç—å –±–ª–∏–∂–∞–π—à–∏–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Å–ª–æ—Ç—ã –¥–ª—è –ª–æ–∫–∞—Ü–∏–∏
        async function getNearestAvailableSlots(locationKey, serviceId) {
            const cacheKey = `${locationKey}_${serviceId}`;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à
            if (availableDatesCache.has(cacheKey)) {
                return availableDatesCache.get(cacheKey);
            }

            try {
                const staffId = API_CONFIG.locations[locationKey].staffId;
                const url = `http://localhost:3000/api/nearest-slots?companyId=${API_CONFIG.companyId}&staffId=${staffId}&serviceId=${serviceId}`;
                
                console.log('üîç –ü–æ–ª—É—á–∞–µ–º –±–ª–∏–∂–∞–π—à–∏–µ —Å–ª–æ—Ç—ã –¥–ª—è:', { locationKey, serviceId, staffId });
                
                const response = await fetch(url);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('‚úÖ –ë–ª–∏–∂–∞–π—à–∏–µ —Å–ª–æ—Ç—ã –ø–æ–ª—É—á–µ–Ω—ã:', data);
                    
                    // –ö—ç—à–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                    availableDatesCache.set(cacheKey, data);
                    return data;
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –±–ª–∏–∂–∞–π—à–∏—Ö —Å–ª–æ—Ç–æ–≤:', error);
                return null;
            }
        }

        // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –Ω—É–∂–Ω–æ –ª–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –¥–∞—Ç—É (–¥–æ –±–ª–∏–∂–∞–π—à–µ–≥–æ –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ —Å–ª–æ—Ç–∞)
        function isDateBeforeNearestAvailable(dateString) {
            const selectedLocation = getSelectedLocation();
            const selectedDuration = getSelectedDuration();
            const cacheKey = `${selectedLocation}_${selectedDuration}`;
            
            console.log(`üîç [isDateBeforeNearestAvailable] –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–∞—Ç—É: ${dateString} –¥–ª—è ${cacheKey}`);
            
            if (!nearestAvailableDates.has(cacheKey)) {
                console.log(`‚ùå [isDateBeforeNearestAvailable] –ö—ç—à –¥–ª—è ${cacheKey} –ø—É—Å—Ç. –ù–µ –±–ª–æ–∫–∏—Ä—É–µ–º.`);
                return false; // –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö, –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ–º
            }
            
            const nearestData = nearestAvailableDates.get(cacheKey);
            if (!nearestData || !nearestData.data || !nearestData.data.seance_date) {
                console.log(`‚ùå [isDateBeforeNearestAvailable] –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –±–ª–∏–∂–∞–π—à–µ–º —Å–ª–æ—Ç–µ –¥–ª—è ${cacheKey}. –ù–µ –±–ª–æ–∫–∏—Ä—É–µ–º.`);
                return false;
            }
            
            // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–æ–ª—å–∫–æ –¥–∞—Ç—É –∏–∑ ISO —Å—Ç—Ä–æ–∫–∏ (—É–±–∏—Ä–∞–µ–º –≤—Ä–µ–º—è)
            const nearestDateStr = nearestData.data.seance_date.split('T')[0];
            const checkDateStr = dateString;
            
            console.log(`üìÖ [isDateBeforeNearestAvailable] –ë–ª–∏–∂–∞–π—à–∞—è –¥–æ—Å—Ç—É–ø–Ω–∞—è –¥–∞—Ç–∞ (–∏–∑ API): ${nearestDateStr}`);
            console.log(`üìÖ [isDateBeforeNearestAvailable] –ü—Ä–æ–≤–µ—Ä—è–µ–º–∞—è –¥–∞—Ç–∞: ${checkDateStr}`);
            
            // –ë–ª–æ–∫–∏—Ä—É–µ–º –¥–∞—Ç—ã –¥–æ –±–ª–∏–∂–∞–π—à–µ–≥–æ –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ —Å–ª–æ—Ç–∞ (—Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Å—Ç—Ä–æ–∫–∏ –¥–∞—Ç)
            const shouldBlock = checkDateStr < nearestDateStr;
            console.log(`üö´ [isDateBeforeNearestAvailable] –†–µ–∑—É–ª—å—Ç–∞—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏: ${shouldBlock} (${checkDateStr} < ${nearestDateStr})`);
            
            return shouldBlock;
        }

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –±–ª–∏–∂–∞–π—à–∏–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –¥–∞—Ç—ã –¥–ª—è –≤—Å–µ—Ö –ª–æ–∫–∞—Ü–∏–π –∏ —É—Å–ª—É–≥
        async function loadNearestAvailableDates() {
            console.log('üîÑ [loadNearestAvailableDates] –ù–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –±–ª–∏–∂–∞–π—à–∏—Ö –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–∞—Ç...');
            
            for (const locationKey of Object.keys(API_CONFIG.locations)) {
                console.log(`üìç [loadNearestAvailableDates] –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ª–æ–∫–∞—Ü–∏—é: ${locationKey}`);
                
                for (const duration of Object.keys(API_CONFIG.locations[locationKey].services)) {
                    const serviceId = API_CONFIG.locations[locationKey].services[duration];
                    const cacheKey = `${locationKey}_${duration}`;
                    
                    console.log(`‚è±Ô∏è [loadNearestAvailableDates] –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è ${locationKey} (${duration} –º–∏–Ω, serviceId: ${serviceId})`);
                    
                    try {
                        const data = await getNearestAvailableSlots(locationKey, serviceId);
                        console.log(`üì• [loadNearestAvailableDates] –ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –¥–ª—è ${cacheKey}:`, data);
                        
                        if (data && data.success) {
                            nearestAvailableDates.set(cacheKey, data);
                            console.log(`‚úÖ [loadNearestAvailableDates] –°–æ—Ö—Ä–∞–Ω–µ–Ω—ã –±–ª–∏–∂–∞–π—à–∏–µ –¥–∞—Ç—ã –¥–ª—è ${locationKey} (${duration} –º–∏–Ω): ${data.data.seance_date}`);
                        } else {
                            console.log(`‚ùå [loadNearestAvailableDates] –ù–µ—É—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç –¥–ª—è ${cacheKey}:`, data);
                        }
                    } catch (error) {
                        console.error(`‚ùå [loadNearestAvailableDates] –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–ª–∏–∂–∞–π—à–∏—Ö –¥–∞—Ç –¥–ª—è ${locationKey} (${duration} –º–∏–Ω):`, error);
                    }
                }
            }
            
            console.log('‚úÖ [loadNearestAvailableDates] –í—Å–µ –±–ª–∏–∂–∞–π—à–∏–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –¥–∞—Ç—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
            console.log('üìä [loadNearestAvailableDates] –ò—Ç–æ–≥–æ–≤—ã–π –∫—ç—à:', Array.from(nearestAvailableDates.entries()));
        }

        // Load time slots from API
        async function loadTimeSlots() {
            const timeSlots = document.querySelector('.time-section .time-slots-grid');
            if (!timeSlots) return;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–∫–µ–ª–µ—Ç –∞–Ω–∏–º–∞—Ü–∏—é
            timeSlots.innerHTML = `
                <div class="time-slot skeleton"></div>
                <div class="time-slot skeleton"></div>
                <div class="time-slot skeleton"></div>
                <div class="time-slot skeleton"></div>
                <div class="time-slot skeleton"></div>
                <div class="time-slot skeleton"></div>
            `;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–∫–µ–ª–µ—Ç–æ–Ω —Å—Ä–∞–∑—É, –±–µ–∑ –∑–∞–¥–µ—Ä–∂–∫–∏
            requestAnimationFrame(async () => {
                try {
                const selectedDuration = getSelectedDuration();
                const selectedLocation = getSelectedLocation();
                const selectedDate = getCurrentDate();
                
                console.log('üîç –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ª–æ—Ç—ã:', {
                    duration: selectedDuration,
                    location: selectedLocation,
                    date: selectedDate
                });
                
                const serviceId = API_CONFIG.locations[selectedLocation].services[selectedDuration];
                const staffId = API_CONFIG.locations[selectedLocation].staffId;
                
                const url = `${API_CONFIG.proxyUrl}/api/slots?companyId=${API_CONFIG.companyId}&staffId=${staffId}&serviceId=${serviceId}&date=${selectedDate}`;
                
                const response = await fetch(url);
                
                if (response.ok) {
                    const data = await response.json();
                    displayTimeSlots(data);
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ª–æ—Ç–æ–≤:', error);
                    const timeSlots = document.querySelector('.time-section .time-slots-grid');
                    if (timeSlots) {
                        timeSlots.innerHTML = `<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ª–æ—Ç–æ–≤: ${error.message}</div>`;
                    }
                }
            }); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–∫–µ–ª–µ—Ç–æ–Ω —Å—Ä–∞–∑—É —á–µ—Ä–µ–∑ requestAnimationFrame
        }

        // Display time slots
        function displayTimeSlots(data) {
            const timeSlots = document.querySelector('.time-section .time-slots-grid');
            if (!timeSlots) return;
            
            timeSlots.innerHTML = '';
            
            if (data.success && data.data && Array.isArray(data.data) && data.data.length > 0) {
                data.data.forEach(slot => {
                    const slotElement = document.createElement('div');
                    slotElement.className = 'time-slot';
                    slotElement.textContent = slot.time;
                    slotElement.dataset.time = slot.time;
                    slotElement.dataset.datetime = slot.datetime;
                    
                    slotElement.addEventListener('click', function() {
                        document.querySelectorAll('.time-slot').forEach(s => s.classList.remove('selected'));
                        this.classList.add('selected');
                    });
                    
                    timeSlots.appendChild(slotElement);
                });
            } else {
                timeSlots.innerHTML = `
                    <div class="form-error">
                        <div class="form-error-icon">‚ö†Ô∏è</div>
                        <div class="form-error-title">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤ –Ω–∞ —ç—Ç—É –¥–∞—Ç—É</div>
                        <div class="form-error-description">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–π –¥–µ–Ω—å</div>
                    </div>
                `;
            }
        }

        // Helper functions
        function getSelectedDuration() {
            const selectedDuration = document.querySelector('.duration-option.selected');
            return parseInt(selectedDuration.dataset.duration);
        }

        function getSelectedLocation() {
            const selectedLocationBtn = document.querySelector('.location-btn.selected');
            return selectedLocationBtn.dataset.location;
        }

        function getServiceIdForLocation(locationKey) {
            const selectedDuration = getSelectedDuration();
            return API_CONFIG.locations[locationKey].services[selectedDuration];
        }

        function getStaffIdForLocation(locationKey) {
            return API_CONFIG.locations[locationKey].staffId;
        }

        // Calculate total price
        function calculateTotalPrice() {
            const duration = getSelectedDuration();
            const trainer = getSelectedTrainer();
            
            if (!PRICES[duration]) {
                return 0;
            }
            
            let price;
            if (trainer === 'with') {
                price = PRICES[duration].withTrainer;
            } else {
                price = PRICES[duration].base;
            }
            
            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —á–∏—Å–ª–æ —Å –ø—Ä–æ–±–µ–ª–∞–º–∏ –¥–ª—è —Ç—ã—Å—è—á
            return price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
        }

        // Update trainer price display
        function updateTrainerPrice() {
            const duration = getSelectedDuration();
            const trainerPriceElement = document.getElementById('trainerPrice');
            
            if (trainerPriceElement && PRICES[duration]) {
                const basePrice = PRICES[duration].base;
                const withTrainerPrice = PRICES[duration].withTrainer;
                const difference = withTrainerPrice - basePrice;
                
                // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —á–∏—Å–ª–æ —Å –ø—Ä–æ–±–µ–ª–∞–º–∏ –¥–ª—è —Ç—ã—Å—è—á
                const formattedDifference = difference.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
                trainerPriceElement.textContent = `+${formattedDifference} AED`;
            }
        }

        // Popup functions
        function showPopup(type, title, message) {
            const overlay = document.getElementById('popupOverlay');
            const icon = document.getElementById('popupIcon');
            const titleEl = document.getElementById('popupTitle');
            const messageEl = document.getElementById('popupMessage');
            
            // Set content
            titleEl.textContent = title;
            messageEl.textContent = message;
            
            // Set icon and style
            if (type === 'success') {
                icon.textContent = '‚úì';
                icon.className = 'popup-icon success';
            } else {
                icon.textContent = '‚úï';
                icon.className = 'popup-icon error';
            }
            
            // Show popup
            overlay.classList.add('show');
        }

        function hidePopup() {
            const overlay = document.getElementById('popupOverlay');
            overlay.classList.remove('show');
        }

        function getSelectedTrainer() {
            const selectedTrainer = document.querySelector('.trainer-btn.selected');
            return selectedTrainer.dataset.trainer;
        }

        function getCurrentDate() {
            const selectedDateElement = document.querySelector('.calendar-date.selected');
            if (selectedDateElement && selectedDateElement.dataset.date) {
                return selectedDateElement.dataset.date;
            }
            const today = new Date();
            return today.toISOString().split('T')[0];
        }

        function getSelectedTimeSlot() {
            const selectedSlot = document.querySelector('.time-slot.selected');
            return selectedSlot ? selectedSlot.dataset.time : null;
        }

        // Send booking to Telegram
        async function sendToTelegram(bookingData) {
            const message = `
*–ù–æ–≤–∞—è –±—Ä–æ–Ω—å WakeMe*

*–ö–ª–∏–µ–Ω—Ç:* ${bookingData.name}
*–¢–µ–ª–µ—Ñ–æ–Ω:* ${bookingData.phone}
*–õ–æ–∫–∞—Ü–∏—è:* ${bookingData.location}
*–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:* ${bookingData.duration} –º–∏–Ω
*–¢—Ä–µ–Ω–µ—Ä:* ${bookingData.trainer === 'with' ? '–° —Ç—Ä–µ–Ω–µ—Ä–æ–º' : '–ë–µ–∑ —Ç—Ä–µ–Ω–µ—Ä–∞'}
*–í—Ä–µ–º—è:* ${bookingData.time}
*–°—Ç–æ–∏–º–æ—Å—Ç—å:* ${bookingData.total} AED
*–î–∞—Ç–∞:* ${bookingData.date}
            `;

            try {
                const response = await fetch(`${API_CONFIG.proxyUrl}/api/send-telegram`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message
                    })
                });

                if (response.ok) {
                    return true;
                } else {
                    throw new Error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram:', error);
                return false;
            }
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Popup button handler
            document.getElementById('popupButton').addEventListener('click', hidePopup);
            document.getElementById('popupOverlay').addEventListener('click', function(e) {
                if (e.target === this) {
                    hidePopup();
                }
            });
            // Duration selection
            document.querySelectorAll('.duration-option').forEach(option => {
                option.addEventListener('click', function() {
                    console.log('‚è±Ô∏è [DURATION] –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏');
                    
                    document.querySelectorAll('.duration-option').forEach(o => o.classList.remove('selected'));
                    this.classList.add('selected');
                    updateTrainerPrice(); // –û–±–Ω–æ–≤–ª—è–µ–º —Ü–µ–Ω—É —Ç—Ä–µ–Ω–µ—Ä–∞
                    clearAvailabilityCache(); // –û—á–∏—â–∞–µ–º –∫–µ—à –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –ø—Ä–∏ —Å–º–µ–Ω–µ —É—Å–ª—É–≥–∏
                    
                    // –ù–û–í–ê–Ø –ê–†–•–ò–¢–ï–ö–¢–£–†–ê: –°–æ–±—ã—Ç–∏–π–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
                    const selectedDuration = getSelectedDuration();
                    const selectedLocation = getSelectedLocation();
                    const cacheKey = `${selectedLocation}_${selectedDuration}`;
                    
                    console.log('üîÑ [DURATION] –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Å –Ω–æ–≤–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π');
                    
                    onServiceOrLocationChange({
                        cacheKey,
                        fetchAvailability,
                        renderCalendar: renderCalendarFromData,
                        highlightDate,
                        fetchSlots: loadSlotsSafe
                    });
                });
            });

            // Trainer selection
            document.querySelectorAll('.trainer-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.trainer-btn').forEach(b => b.classList.remove('selected'));
                    this.classList.add('selected');
                });
            });

            // Location selection
            document.querySelectorAll('.location-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    console.log('üîÑ [LOCATION] –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ª–æ–∫–∞—Ü–∏–∏');
                    
                    document.querySelectorAll('.location-btn').forEach(b => b.classList.remove('selected'));
                    this.classList.add('selected');
                    clearAvailabilityCache(); // –û—á–∏—â–∞–µ–º –∫–µ—à –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –ø—Ä–∏ —Å–º–µ–Ω–µ –ª–æ–∫–∞—Ü–∏–∏
                    
                    // –ù–û–í–ê–Ø –ê–†–•–ò–¢–ï–ö–¢–£–†–ê: –°–æ–±—ã—Ç–∏–π–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
                    const selectedDuration = getSelectedDuration();
                    const selectedLocation = getSelectedLocation();
                    const cacheKey = `${selectedLocation}_${selectedDuration}`;
                    
                    console.log('üîÑ [LOCATION] –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ª–æ–∫–∞—Ü–∏–∏ —Å –Ω–æ–≤–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π');
                    
                    onServiceOrLocationChange({
                        cacheKey,
                        fetchAvailability,
                        renderCalendar: renderCalendarFromData,
                        highlightDate,
                        fetchSlots: loadSlotsSafe
                    });
                });
            });


            // Booking form submission
            document.getElementById('bookingForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const selectedTime = getSelectedTimeSlot();
                if (!selectedTime) {
                    showPopup('error', '–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è', '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è –¥–ª—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è');
                    return;
                }

                const bookingData = {
                    name: document.getElementById('clientName').value,
                    phone: document.getElementById('clientPhone').value,
                    location: getSelectedLocation(),
                    duration: getSelectedDuration(),
                    trainer: getSelectedTrainer(),
                    time: selectedTime,
                    date: getCurrentDate(),
                    total: calculateTotalPrice()
                };

                const bookingBtn = document.getElementById('bookingBtn');
                bookingBtn.disabled = true;
                bookingBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';

                try {
                    const success = await sendToTelegram(bookingData);
                    
                    if (success) {
                        showPopup('success', '–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!', '–ú—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –≤ WhatsApp –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –¥–∞—Ç—ã');
                        document.getElementById('bookingForm').reset();
                        document.querySelectorAll('.time-slot').forEach(s => s.classList.remove('selected'));
                    } else {
                        showPopup('error', '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
                    }
                } catch (error) {
                    showPopup('error', '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
                } finally {
                    bookingBtn.disabled = false;
                    bookingBtn.textContent = '–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å';
                }
            });
        });

        // Calendar variables
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        
        // Cache for date availability
        let dateAvailabilityCache = new Map();
        
        // Clear availability cache when location or service changes
        function clearAvailabilityCache() {
            console.log('üßπ [clearAvailabilityCache] –û—á–∏—â–∞–µ–º –∫–µ—à –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –¥–∞—Ç');
            dateAvailabilityCache.clear();
        }
        
        // Check if slots are available for a specific date
        async function checkDateAvailability(dateString) {
            console.log(`üîç [checkDateAvailability] –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –¥–ª—è –¥–∞—Ç—ã: ${dateString}`);
            
            // Check cache first
            if (dateAvailabilityCache.has(dateString)) {
                const cached = dateAvailabilityCache.get(dateString);
                console.log(`üìã [checkDateAvailability] –ù–∞–π–¥–µ–Ω–æ –≤ –∫–µ—à–µ: ${dateString} = ${cached}`);
                return cached;
            }
            
            try {
                const locationKey = getSelectedLocation();
                const serviceId = getServiceIdForLocation(locationKey);
                const staffId = getStaffIdForLocation(locationKey);
                const companyId = API_CONFIG.companyId;
                
                console.log(`üì§ [checkDateAvailability] –ó–∞–ø—Ä–æ—Å —Å–ª–æ—Ç–æ–≤ –¥–ª—è ${dateString}:`, {
                    locationKey, serviceId, staffId, companyId
                });
                
                const response = await fetch(`${API_CONFIG.proxyUrl}/api/slots?companyId=${companyId}&staffId=${staffId}&serviceId=${serviceId}&date=${dateString}`);
                
                if (!response.ok) {
                    console.log(`‚ùå [checkDateAvailability] –û—à–∏–±–∫–∞ API –¥–ª—è ${dateString}: ${response.status}`);
                    dateAvailabilityCache.set(dateString, false);
                    return false;
                }
                
                const data = await response.json();
                const hasSlots = data.success && data.data && data.data.length > 0;
                
                console.log(`üìä [checkDateAvailability] –†–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è ${dateString}: ${hasSlots ? '–ï—Å—Ç—å —Å–ª–æ—Ç—ã' : '–ù–µ—Ç —Å–ª–æ—Ç–æ–≤'}`);
                
                // Cache the result
                dateAvailabilityCache.set(dateString, hasSlots);
                return hasSlots;
                
            } catch (error) {
                console.error(`‚ùå [checkDateAvailability] –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ ${dateString}:`, error);
                dateAvailabilityCache.set(dateString, false);
                return false;
            }
        }

        // Calendar navigation
        function changeMonth(direction) {
            console.log('üìÖ [changeMonth] –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ—Å—è—Ü–∞');
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É
            const currentSelectedDate = document.querySelector('.calendar-date.selected');
            const selectedDate = currentSelectedDate ? currentSelectedDate.dataset.date : null;
            console.log('üìÖ [changeMonth] –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É:', selectedDate);
            
            const today = new Date();
            const currentDate = new Date(currentYear, currentMonth);
            const todayDate = new Date(today.getFullYear(), today.getMonth());
            
            currentMonth += direction;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            } else if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            
            // Check if we're trying to go to a past month
            const newDate = new Date(currentYear, currentMonth);
            if (newDate < todayDate) {
                // Revert the change
                currentMonth -= direction;
                if (currentMonth < 0) {
                    currentMonth = 11;
                    currentYear--;
                } else if (currentMonth > 11) {
                    currentMonth = 0;
                    currentYear++;
                }
                return; // Don't render if we can't go to past month
            }
            
            console.log('üìÖ [changeMonth] –†–µ–Ω–¥–µ—Ä–∏–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å');
            renderCalendar();
            
            // –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ —Å –±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–æ–π
            const waitForCalendarReady = () => {
                return new Promise((resolve) => {
                    const checkCalendar = () => {
                        const calendarDates = document.querySelectorAll('.calendar-date:not(.other-month)');
                        const hasDates = calendarDates.length > 0;
                        
                        console.log(`üîç [changeMonth] –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫–∞–ª–µ–Ω–¥–∞—Ä—è: ${hasDates}, –¥–∞—Ç: ${calendarDates.length}`);
                        
                        if (hasDates) {
                            console.log('‚úÖ [changeMonth] –ö–∞–ª–µ–Ω–¥–∞—Ä—å –≥–æ—Ç–æ–≤');
                            resolve();
                        } else {
                            console.log('‚è≥ [changeMonth] –ñ–¥–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è...');
                            setTimeout(checkCalendar, 100);
                        }
                    };
                    checkCalendar();
                });
            };
            
            waitForCalendarReady().then(() => {
                // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
                setTimeout(() => {
                    if (selectedDate) {
                        const dateElement = document.querySelector(`.calendar-date[data-date="${selectedDate}"]`);
                        if (dateElement && !dateElement.classList.contains('disabled')) {
                            console.log('‚úÖ [changeMonth] –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞—Ç—É:', selectedDate);
                            selectDate(dateElement, selectedDate);
                            
                            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ª–æ—Ç—ã –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–π –¥–∞—Ç—ã
                            loadTimeSlots();
                        } else {
                            console.log('‚ùå [changeMonth] –î–∞—Ç–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –≤ –Ω–æ–≤–æ–º –º–µ—Å—è—Ü–µ, –ù–ï –ú–ï–ù–Ø–ï–ú –¥–∞—Ç—É');
                            // –ù–ï –º–µ–Ω—è–µ–º –¥–∞—Ç—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ - –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å
                            // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∞–º –≤—ã–±–µ—Ä–µ—Ç –Ω–æ–≤—É—é –¥–∞—Ç—É –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
                        }
                    } else {
                        console.log('üéØ [changeMonth] –ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–π –¥–∞—Ç—ã, –ù–ï —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—É—é');
                        // –ù–ï —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—É—é –¥–∞—Ç—É –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –º–µ—Å—è—Ü–µ–≤
                        // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∞–º –≤—ã–±–µ—Ä–µ—Ç –¥–∞—Ç—É
                    }
                }, 300); // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∑–∞–¥–µ—Ä–∂–∫—É –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
            });
        }

        // Render calendar
        function renderCalendar() {
            console.log('üìÖ [renderCalendar] –ù–∞—á–∏–Ω–∞–µ–º —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ –∫–∞–ª–µ–Ω–¥–∞—Ä—è');
            console.log('üîç [renderCalendar] –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–∞—Ç –ø–µ—Ä–µ–¥ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–æ–º:', {
                selectedDates: document.querySelectorAll('.calendar-date.selected').length,
                totalDates: document.querySelectorAll('.calendar-date').length
            });
            const calendarGrid = document.querySelector('.calendar-grid');
            const calendarMonthDisplay = document.querySelector('.calendar-month');
            
            if (!calendarGrid || !calendarMonthDisplay) {
                console.log('‚ùå [renderCalendar] –ù–µ –Ω–∞–π–¥–µ–Ω—ã —ç–ª–µ–º–µ–Ω—Ç—ã –∫–∞–ª–µ–Ω–¥–∞—Ä—è');
                return;
            }
            
            console.log('üßπ [renderCalendar] –û—á–∏—â–∞–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å');
            calendarGrid.innerHTML = ''; // –û—á–∏—â–∞–µ–º –ø–µ—Ä–µ–¥ –ø–æ–∫–∞–∑–æ–º —Å–∫–µ–ª–µ—Ç–∞
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–∫–µ–ª–µ—Ç –∞–Ω–∏–º–∞—Ü–∏—é –¥–ª—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è
            calendarGrid.innerHTML = `
                <div class="calendar-date skeleton"></div>
                <div class="calendar-date skeleton"></div>
                <div class="calendar-date skeleton"></div>
                <div class="calendar-date skeleton"></div>
                <div class="calendar-date skeleton"></div>
                <div class="calendar-date skeleton"></div>
                <div class="calendar-date skeleton"></div>
                <div class="calendar-date skeleton"></div>
                <div class="calendar-date skeleton"></div>
                <div class="calendar-date skeleton"></div>
                <div class="calendar-date skeleton"></div>
                <div class="calendar-date skeleton"></div>
                <div class="calendar-date skeleton"></div>
                <div class="calendar-date skeleton"></div>
                <div class="calendar-date skeleton"></div>
                <div class="calendar-date skeleton"></div>
                <div class="calendar-date skeleton"></div>
                <div class="calendar-date skeleton"></div>
                <div class="calendar-date skeleton"></div>
                <div class="calendar-date skeleton"></div>
                <div class="calendar-date skeleton"></div>
                <div class="calendar-date skeleton"></div>
                <div class="calendar-date skeleton"></div>
                <div class="calendar-date skeleton"></div>
                <div class="calendar-date skeleton"></div>
                <div class="calendar-date skeleton"></div>
                <div class="calendar-date skeleton"></div>
                <div class="calendar-date skeleton"></div>
                <div class="calendar-date skeleton"></div>
                <div class="calendar-date skeleton"></div>
                <div class="calendar-date skeleton"></div>
                <div class="calendar-date skeleton"></div>
                <div class="calendar-date skeleton"></div>
                <div class="calendar-date skeleton"></div>
                <div class="calendar-date skeleton"></div>
                <div class="calendar-date skeleton"></div>
            `;

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–∫–µ–ª–µ—Ç–æ–Ω —Å—Ä–∞–∑—É, –±–µ–∑ –∑–∞–¥–µ—Ä–∂–∫–∏
            console.log('‚è≥ [renderCalendar] –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–∫–µ–ª–µ—Ç –∞–Ω–∏–º–∞—Ü–∏—é —Å—Ä–∞–∑—É');
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º requestAnimationFrame –¥–ª—è –ø–æ–∫–∞–∑–∞ —Å–∫–µ–ª–µ—Ç–æ–Ω–∞ –≤ —Å–ª–µ–¥—É—é—â–µ–º –∫–∞–¥—Ä–µ
            requestAnimationFrame(() => {
                console.log('‚è≥ [renderCalendar] –ù–∞—á–∏–Ω–∞–µ–º —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞—Ç');
                // –û—á–∏—â–∞–µ–º —Å–∫–µ–ª–µ—Ç –ø–µ—Ä–µ–¥ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–æ–º —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞—Ç
                calendarGrid.innerHTML = '';
                
                const firstDayOfMonth = new Date(currentYear, currentMonth, 1).getDay();
                const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

                calendarMonthDisplay.textContent = `${new Date(currentYear, currentMonth).toLocaleString('ru-RU', { month: 'long' })} ${currentYear}`;

                // Days of week
                const daysOfWeek = ['–ü–ù', '–í–¢', '–°–†', '–ß–¢', '–ü–¢', '–°–ë', '–í–°'];
                daysOfWeek.forEach(day => {
                    const dayElement = document.createElement('div');
                    dayElement.className = 'calendar-day';
                    dayElement.textContent = day;
                    calendarGrid.appendChild(dayElement);
                });

                // Adjust first day to be Monday (0 for Sunday, 1 for Monday, etc.)
                let startDay = firstDayOfMonth === 0 ? 6 : firstDayOfMonth - 1;

                // Add empty divs for days before the 1st
                for (let i = 0; i < startDay; i++) {
                    const emptyDate = document.createElement('div');
                    emptyDate.className = 'calendar-date other-month';
                    const prevMonthDays = new Date(currentYear, currentMonth, 0).getDate();
                    emptyDate.textContent = prevMonthDays - startDay + i + 1;
                    calendarGrid.appendChild(emptyDate);
                }

                // Add days of the current month
                for (let i = 1; i <= daysInMonth; i++) {
                    const dateElement = document.createElement('div');
                    const cellDate = new Date(currentYear, currentMonth, i);
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    const isPastDate = cellDate < today;
                
                    dateElement.className = 'calendar-date';
                    dateElement.textContent = i;
                    dateElement.dataset.date = `${currentYear}-${(currentMonth + 1).toString().padStart(2, '0')}-${i.toString().padStart(2, '0')}`;
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –¥–∞—Ç—É
                    const dateString = dateElement.dataset.date;
                    const isBeforeNearest = isDateBeforeNearestAvailable(dateString);
                    const shouldDisable = isPastDate || isBeforeNearest;
                    
                    console.log(`üìÖ [renderCalendar] –î–∞—Ç–∞ ${dateString}: –ø—Ä–æ—à–ª–∞—è=${isPastDate}, –¥–æ –±–ª–∏–∂–∞–π—à–µ–≥–æ=${isBeforeNearest}, –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å=${shouldDisable}`);
                    
                    if (shouldDisable) {
                        dateElement.classList.add('disabled');
                        dateElement.style.opacity = '0.3';
                        dateElement.style.cursor = 'not-allowed';
                        console.log(`üö´ [renderCalendar] –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞ –¥–∞—Ç–∞: ${dateString}`);
                    } else {
                        // Check availability for non-disabled dates
                        checkDateAvailability(dateString).then(hasSlots => {
                            if (!hasSlots) {
                                dateElement.classList.add('no-slots');
                                console.log(`üö´ [renderCalendar] –ù–µ—Ç —Å–ª–æ—Ç–æ–≤ –¥–ª—è –¥–∞—Ç—ã: ${dateString}`);
                            }
                        });
                        
                        // –ù–ï –≤—ã–¥–µ–ª—è–µ–º —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é –¥–∞—Ç—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ - —ç—Ç–æ –±—É–¥–µ—Ç —Å–¥–µ–ª–∞–Ω–æ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –æ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
                        // const hasSelectedDate = document.querySelector('.calendar-date.selected');
                        // if (i === today.getDate() && currentMonth === today.getMonth() && currentYear === today.getFullYear() && !hasSelectedDate) {
                        //     dateElement.classList.add('selected');
                        // }

                        dateElement.addEventListener('click', function() {
                            // Don't allow clicking on dates without slots
                            if (this.classList.contains('no-slots')) {
                                console.log(`üö´ [renderCalendar] –ü–æ–ø—ã—Ç–∫–∞ –∫–ª–∏–∫–∞ –Ω–∞ –¥–∞—Ç—É –±–µ–∑ —Å–ª–æ—Ç–æ–≤: ${dateString}`);
                                return;
                            }
                            
                            console.log(`üñ±Ô∏è [renderCalendar] –ö–ª–∏–∫ –ø–æ –¥–∞—Ç–µ: ${dateString}`);
                            selectDate(this, dateString);
                            loadTimeSlots();
                        });
                    }
                    
                    calendarGrid.appendChild(dateElement);
                }
            
                console.log('‚úÖ [renderCalendar] –ö–∞–ª–µ–Ω–¥–∞—Ä—å –æ—Ç—Ä–µ–Ω–¥–µ—Ä–µ–Ω');
                console.log('üìä [renderCalendar] –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä—è:', {
                    totalDates: document.querySelectorAll('.calendar-date').length,
                    disabledDates: document.querySelectorAll('.calendar-date.disabled').length,
                    selectedDates: document.querySelectorAll('.calendar-date.selected').length,
                    availableDates: document.querySelectorAll('.calendar-date:not(.disabled)').length
                });
                
                // –ù–ï —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—É—é –¥–∞—Ç—É –∑–¥–µ—Å—å - —ç—Ç–æ –¥–µ–ª–∞–µ—Ç—Å—è –≤ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
                console.log('üìÖ [renderCalendar] –ö–∞–ª–µ–Ω–¥–∞—Ä—å –æ—Ç—Ä–µ–Ω–¥–µ—Ä–µ–Ω, –¥–∞—Ç–∞ –±—É–¥–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –æ—Ç–¥–µ–ª—å–Ω–æ');
            }); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–∫–µ–ª–µ—Ç–æ–Ω —Å—Ä–∞–∑—É —á–µ—Ä–µ–∑ requestAnimationFrame
        }

        function setDefaultSelections() {
            console.log('‚öôÔ∏è [setDefaultSelections] –ù–∞—á–∏–Ω–∞–µ–º —É—Å—Ç–∞–Ω–æ–≤–∫—É –¥–µ—Ñ–æ–ª—Ç–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π');
            
            // –°–Ω–∞—á–∞–ª–∞ —É–±–∏—Ä–∞–µ–º –≤—Å–µ –≤—ã–¥–µ–ª–µ–Ω–∏—è
            console.log('üßπ [setDefaultSelections] –£–±–∏—Ä–∞–µ–º –≤—Å–µ –≤—ã–¥–µ–ª–µ–Ω–∏—è');
            document.querySelectorAll('.duration-option').forEach(option => {
                option.classList.remove('selected');
            });
            document.querySelectorAll('.trainer-btn').forEach(btn => {
                btn.classList.remove('selected');
            });

            // –í—ã–±–∏—Ä–∞–µ–º 60 –º–∏–Ω—É—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            const duration60 = document.querySelector('.duration-option[data-duration="60"]');
            if (duration60) {
                duration60.classList.add('selected');
                console.log('‚úÖ [setDefaultSelections] –í—ã–±—Ä–∞–Ω–∞ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: 60 –º–∏–Ω—É—Ç');
            } else {
                console.log('‚ùå [setDefaultSelections] –ù–µ –Ω–∞–π–¥–µ–Ω–∞ –æ–ø—Ü–∏—è 60 –º–∏–Ω—É—Ç');
            }

            // –í—ã–±–∏—Ä–∞–µ–º "—Å —Ç—Ä–µ–Ω–µ—Ä–æ–º" –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            const withTrainer = document.querySelector('.trainer-btn[data-trainer="with"]');
            if (withTrainer) {
                withTrainer.classList.add('selected');
                console.log('‚úÖ [setDefaultSelections] –í—ã–±—Ä–∞–Ω —Ç—Ä–µ–Ω–µ—Ä: —Å —Ç—Ä–µ–Ω–µ—Ä–æ–º');
            } else {
                console.log('‚ùå [setDefaultSelections] –ù–µ –Ω–∞–π–¥–µ–Ω–∞ –æ–ø—Ü–∏—è "—Å —Ç—Ä–µ–Ω–µ—Ä–æ–º"');
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º —Ü–µ–Ω—É —Ç—Ä–µ–Ω–µ—Ä–∞ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π —É—Å–ª—É–≥–∏
            updateTrainerPrice();
            
            // –ù–ï —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞—Ç—É –∑–¥–µ—Å—å - –æ–Ω–∞ –±—É–¥–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –æ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
            console.log('üìÖ [setDefaultSelections] –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —É—Å—Ç–∞–Ω–æ–≤–∫—É –¥–∞—Ç—ã - –±—É–¥–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
        }

        // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–µ—Ñ–æ–ª—Ç–Ω—É—é –¥–∞—Ç—É (–±–ª–∏–∂–∞–π—à—É—é –¥–æ—Å—Ç—É–ø–Ω—É—é)
        function setDefaultDate() {
            return new Promise((resolve) => {
            console.log('üéØ [setDefaultDate] –í–´–ó–û–í setDefaultDate - —Å—Ç–µ–∫ –≤—ã–∑–æ–≤–æ–≤:', new Error().stack);
            sendLogToServer('SET_DEFAULT_DATE', '–í—ã–∑–æ–≤ setDefaultDate', {
                stack: new Error().stack.split('\n').slice(0, 5)
            });
            const selectedLocation = getSelectedLocation();
            const selectedDuration = getSelectedDuration();
            const cacheKey = `${selectedLocation}_${selectedDuration}`;
            
            console.log(`üéØ [setDefaultDate] –ù–∞—á–∏–Ω–∞–µ–º —É—Å—Ç–∞–Ω–æ–≤–∫—É –¥–µ—Ñ–æ–ª—Ç–Ω–æ–π –¥–∞—Ç—ã –¥–ª—è ${cacheKey}`);
            sendLogToServer('SET_DEFAULT_DATE', `–ù–∞—á–∏–Ω–∞–µ–º —É—Å—Ç–∞–Ω–æ–≤–∫—É –¥–µ—Ñ–æ–ª—Ç–Ω–æ–π –¥–∞—Ç—ã –¥–ª—è ${cacheKey}`);
            
            // –ê–ì–†–ï–°–°–ò–í–ù–û–ï –æ–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –æ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –¥–ª—è –º–æ–±–∏–ª–æ–∫
            const waitForAvailabilityData = () => {
                return new Promise((availabilityResolve) => {
                    let attempts = 0;
                    const maxAttempts = 50; // 5 —Å–µ–∫—É–Ω–¥ –º–∞–∫—Å–∏–º—É–º
                    
                    const checkAvailability = () => {
                        attempts++;
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–∞–ª–µ–Ω–¥–∞—Ä—å –æ—Ç—Ä–µ–Ω–¥–µ—Ä–µ–Ω –∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ –æ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
                        const calendarDates = document.querySelectorAll('.calendar-date:not(.disabled)');
                        const hasAvailabilityData = calendarDates.length > 0;
                        
                        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ - –µ—Å—Ç—å –ª–∏ –¥–∞–Ω–Ω—ã–µ –≤ –∫—ç—à–µ
                        const selectedLocation = getSelectedLocation();
                        const selectedDuration = getSelectedDuration();
                        const cacheKey = `${selectedLocation}_${selectedDuration}`;
                        const hasCacheData = nearestAvailableDates.has(cacheKey);
                        
                        console.log(`üîç [setDefaultDate] –ü–æ–ø—ã—Ç–∫–∞ ${attempts}/${maxAttempts}: –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å=${hasAvailabilityData}, –¥–∞—Ç=${calendarDates.length}, –∫—ç—à=${hasCacheData}`);
                        
                        if (hasAvailabilityData && hasCacheData) {
                            console.log('‚úÖ [setDefaultDate] –î–∞–Ω–Ω—ã–µ –æ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –ò –∫—ç—à –∑–∞–ø–æ–ª–Ω–µ–Ω');
                            availabilityResolve();
                        } else if (attempts >= maxAttempts) {
                            console.log('‚ö†Ô∏è [setDefaultDate] –¢–∞–π–º–∞—É—Ç –æ–∂–∏–¥–∞–Ω–∏—è, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å —Ç–µ–º —á—Ç–æ –µ—Å—Ç—å');
                            availabilityResolve();
                        } else {
                            console.log('‚è≥ [setDefaultDate] –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –æ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏...');
                            setTimeout(checkAvailability, 100);
                        }
                    };
                    checkAvailability();
                });
            };
            
            waitForAvailabilityData().then(() => {
                // –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–ê–Ø –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
                console.log('üì± [setDefaultDate] –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –º–æ–±–∏–ª–æ–∫...');
                setTimeout(() => {
                    let defaultDate = null;
            
            // –ï—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ –æ –±–ª–∏–∂–∞–π—à–∏—Ö –¥–∞—Ç–∞—Ö, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏—Ö
            if (nearestAvailableDates.has(cacheKey)) {
                const nearestData = nearestAvailableDates.get(cacheKey);
                console.log(`üìä [setDefaultDate] –î–∞–Ω–Ω—ã–µ –æ –±–ª–∏–∂–∞–π—à–∏—Ö –¥–∞—Ç–∞—Ö –¥–ª—è ${cacheKey}:`, nearestData);
                
                if (nearestData && nearestData.data && nearestData.data.seance_date) {
                    const nearestDateStr = nearestData.data.seance_date.split('T')[0];
                    defaultDate = nearestDateStr;
                    console.log(`üìÖ [setDefaultDate] –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–ª–∏–∂–∞–π—à—É—é –¥–æ—Å—Ç—É–ø–Ω—É—é –¥–∞—Ç—É: ${defaultDate}`);
                } else {
                    console.log(`‚ùå [setDefaultDate] –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –±–ª–∏–∂–∞–π—à–µ–π –¥–∞—Ç–µ –≤ –∫—ç—à–µ –¥–ª—è ${cacheKey}`);
                }
            } else {
                console.log(`‚ùå [setDefaultDate] –ö—ç—à –ø—É—Å—Ç –¥–ª—è ${cacheKey}, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é –¥–∞—Ç—É`);
                // Fallback –Ω–∞ —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é –¥–∞—Ç—É, –µ—Å–ª–∏ –∫—ç—à –ø—É—Å—Ç
                const today = new Date();
                defaultDate = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getDate().toString().padStart(2, '0')}`;
            }
            
            if (!defaultDate) {
                console.log(`‚ùå [setDefaultDate] –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –¥–µ—Ñ–æ–ª—Ç–Ω—É—é –¥–∞—Ç—É`);
                resolve();
                return;
            }
            
            // –ù–∞—Ö–æ–¥–∏–º –∏ –≤—ã–¥–µ–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç –∫–∞–ª–µ–Ω–¥–∞—Ä—è
            const dateElement = document.querySelector(`.calendar-date[data-date="${defaultDate}"]`);
            console.log(`üîç [setDefaultDate] –ò—â–µ–º —ç–ª–µ–º–µ–Ω—Ç –∫–∞–ª–µ–Ω–¥–∞—Ä—è –¥–ª—è –¥–∞—Ç—ã ${defaultDate}:`, dateElement);
            
            if (dateElement) {
                console.log(`üìã [setDefaultDate] –≠–ª–µ–º–µ–Ω—Ç –Ω–∞–π–¥–µ–Ω, –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω: ${dateElement.classList.contains('disabled')}`);
                
                if (!dateElement.classList.contains('disabled')) {
                    // –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å –¥—Ä—É–≥–∏—Ö –¥–∞—Ç
                    selectDate(dateElement, defaultDate);
                    console.log(`‚úÖ [setDefaultDate] –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –¥–µ—Ñ–æ–ª—Ç–Ω–∞—è –¥–∞—Ç–∞: ${defaultDate}`);
                    resolve();
                } else {
                    console.log(`‚ùå [setDefaultDate] –≠–ª–µ–º–µ–Ω—Ç –¥–ª—è –¥–∞—Ç—ã ${defaultDate} –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω, –∏—â–µ–º —Å–ª–µ–¥—É—é—â—É—é –¥–æ—Å—Ç—É–ø–Ω—É—é –¥–∞—Ç—É`);
                    
                    // –ò—â–µ–º —Å–ª–µ–¥—É—é—â—É—é –¥–æ—Å—Ç—É–ø–Ω—É—é –¥–∞—Ç—É
                    const allDates = Array.from(document.querySelectorAll('.calendar-date:not(.disabled)'));
                    const sortedDates = allDates
                        .map(el => ({ element: el, date: el.dataset.date }))
                        .filter(item => item.date >= defaultDate)
                        .sort((a, b) => a.date.localeCompare(b.date));
                    
                    if (sortedDates.length > 0) {
                        const nextAvailableDate = sortedDates[0];
                        nextAvailableDate.element.classList.add('selected');
                        console.log(`‚úÖ [setDefaultDate] –ù–∞–π–¥–µ–Ω–∞ —Å–ª–µ–¥—É—é—â–∞—è –¥–æ—Å—Ç—É–ø–Ω–∞—è –¥–∞—Ç–∞: ${nextAvailableDate.date}`);
                    } else {
                        console.log(`‚ùå [setDefaultDate] –ù–µ –Ω–∞–π–¥–µ–Ω–æ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–∞—Ç –ø–æ—Å–ª–µ ${defaultDate}`);
                    }
                    resolve();
                }
            } else {
                console.log(`‚ùå [setDefaultDate] –≠–ª–µ–º–µ–Ω—Ç –∫–∞–ª–µ–Ω–¥–∞—Ä—è –¥–ª—è –¥–∞—Ç—ã ${defaultDate} –Ω–µ –Ω–∞–π–¥–µ–Ω`);
                resolve();
            }
            
            // –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –¥–∞—Ç—ã
            const finalSelectedDate = document.querySelector('.calendar-date.selected');
            if (finalSelectedDate) {
                console.log(`üéâ [setDefaultDate] –§–ò–ù–ê–õ–¨–ù–ê–Ø –í–´–ë–†–ê–ù–ù–ê–Ø –î–ê–¢–ê: ${finalSelectedDate.dataset.date}`);
            } else {
                console.log(`‚ùå [setDefaultDate] –ü–†–û–ë–õ–ï–ú–ê: –ù–∏ –æ–¥–Ω–∞ –¥–∞—Ç–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞!`);
                console.log('üîç [setDefaultDate] –î–æ—Å—Ç—É–ø–Ω—ã–µ –¥–∞—Ç—ã:', Array.from(document.querySelectorAll('.calendar-date:not(.disabled)')).map(el => el.dataset.date));
                console.log('üîç [setDefaultDate] –í—Å–µ –¥–∞—Ç—ã:', Array.from(document.querySelectorAll('.calendar-date')).map(el => ({
                    date: el.dataset.date,
                    disabled: el.classList.contains('disabled'),
                    selected: el.classList.contains('selected')
                })));
            }
            });
            }, 500); // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –º–æ–±–∏–ª–æ–∫
            });
        }

        // ===== –ù–û–í–ê–Ø –ê–†–•–ò–¢–ï–ö–¢–£–†–ê: –°–û–ë–´–¢–ò–ô–ù–ê–Ø –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø =====
        
        // –î–≤–æ–π–Ω–æ–π rAF ‚Äî –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –ø–æ—Å–ª–µ layout+paint
        const afterPaint = () => new Promise(r =>
            requestAnimationFrame(() => requestAnimationFrame(r))
        );

        // –ó–∞—â–∏—Ç–∞ –æ—Ç –≥–æ–Ω–æ–∫
        let runId = 0;
        const newRun = () => (++runId);
        const isStale = (id) => id !== runId;

        // –•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –ø–æ cacheKey –∫–∞–∫ –ø—Ä–æ–º–∏—Å
        const availabilityStore = new Map(); // cacheKey -> Promise<Availability>

        function getAvailability(cacheKey, fetchFn, signal) {
            if (!availabilityStore.has(cacheKey)) {
                const p = fetchFn({ signal }).then(data => {
                    if (!data || !Array.isArray(data.dates)) throw new Error('bad data');
                    return data;
                });
                availabilityStore.set(cacheKey, p);
            }
            return availabilityStore.get(cacheKey);
        }

        // –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –∑–∞–≥—Ä—É–∑—á–∏–∫ —Å–ª–æ—Ç–æ–≤ —Å –æ—Ç–º–µ–Ω–æ–π
        async function loadSlotsSafe(dateISO, { signal }) {
            console.log('üéØ [loadSlotsSafe] –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ª–æ—Ç—ã –¥–ª—è:', dateISO);
            
            const selectedDuration = getSelectedDuration();
            const selectedLocation = getSelectedLocation();
            const serviceId = getServiceIdForLocation(selectedLocation, selectedDuration);
            
            const response = await fetch(`https://wakeme-booking-api.onrender.com/api/slots`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    date: dateISO,
                    service_id: serviceId
                }),
                signal
            });
            
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const data = await response.json();
            
            // –†–µ–Ω–¥–µ—Ä–∏–º —Å–ª–æ—Ç—ã –≤—Ä–µ–º–µ–Ω–∏
            renderTimeSlots(data);
            
            return data;
        }

        // –†–µ–Ω–¥–µ—Ä —Å–ª–æ—Ç–æ–≤ –≤—Ä–µ–º–µ–Ω–∏
        function renderTimeSlots(slots) {
            console.log('‚è∞ [renderTimeSlots] –†–µ–Ω–¥–µ—Ä–∏–º —Å–ª–æ—Ç—ã –≤—Ä–µ–º–µ–Ω–∏:', slots);
            
            const timeSlots = document.querySelector('.time-slots');
            if (!timeSlots) return;
            
            if (!slots || !Array.isArray(slots) || slots.length === 0) {
                timeSlots.innerHTML = `
                    <div class="form-error">
                        <div class="form-error-icon">‚ö†Ô∏è</div>
                        <div class="form-error-title">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤</div>
                        <div class="form-error-description">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥—É—é –¥–∞—Ç—É</div>
                    </div>
                `;
                return;
            }
            
            timeSlots.innerHTML = slots.map(slot => `
                <div class="time-slot" data-time="${slot.time}">
                    ${slot.time}
                </div>
            `).join('');
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–∞
            timeSlots.querySelectorAll('.time-slot').forEach(slot => {
                slot.addEventListener('click', function() {
                    document.querySelectorAll('.time-slot').forEach(s => s.classList.remove('selected'));
                    this.classList.add('selected');
                });
            });
        }

        // –û–∂–∏–¥–∞–Ω–∏–µ DOM —ç–ª–µ–º–µ–Ω—Ç–∞ —Å —Ç–∞–π–º–∞—É—Ç–æ–º
        function waitFor(selector, { root = document, timeout = 5000 } = {}) {
            return new Promise((resolve, reject) => {
                const found = root.querySelector(selector);
                if (found) return resolve(found);

                const obs = new MutationObserver(() => {
                    const el = root.querySelector(selector);
                    if (el) { obs.disconnect(); resolve(el); }
                });
                obs.observe(root, { childList: true, subtree: true });

                const t = setTimeout(() => {
                    obs.disconnect();
                    resolve(null); // –Ω–µ reject ‚Äî UI –¥–æ–ª–∂–µ–Ω –¥–µ–≥—Ä–∞–¥–∏—Ä–æ–≤–∞—Ç—å –º—è–≥–∫–æ
                }, timeout);
            });
        }

        // –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–±–æ—Ä–∞ –¥–∞—Ç—ã
        function selectDate(dateElement, dateString = null) {
            console.log('üéØ [selectDate] –í—ã–±–∏—Ä–∞–µ–º –¥–∞—Ç—É:', dateString || dateElement.dataset.date);
            
            // –ö–†–ò–¢–ò–ß–ù–û: –£–±–∏—Ä–∞–µ–º –í–°–ï –≤—ã–¥–µ–ª–µ–Ω–∏—è —Å –í–°–ï–• –¥–∞—Ç
            document.querySelectorAll('.calendar-date').forEach(d => {
                d.classList.remove('selected');
                d.style.background = '';
                d.style.color = '';
            });
            
            // –í—ã–¥–µ–ª—è–µ–º —Ç–æ–ª—å–∫–æ –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É
            dateElement.classList.add('selected');
            dateElement.style.background = '#64D7F2';
            dateElement.style.color = 'white';
            
            console.log('‚úÖ [selectDate] –î–∞—Ç–∞ –≤—ã–±—Ä–∞–Ω–∞:', dateElement.dataset.date);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∞ –¥–∞—Ç–∞ –≤—ã–±—Ä–∞–Ω–∞
            const selectedDates = document.querySelectorAll('.calendar-date.selected');
            if (selectedDates.length > 1) {
                console.error('üö® [selectDate] –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –í—ã–±—Ä–∞–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ –¥–∞—Ç!', selectedDates.length);
                // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∏—Å–ø—Ä–∞–≤–ª—è–µ–º
                selectedDates.forEach((d, index) => {
                    if (index > 0) {
                        d.classList.remove('selected');
                        d.style.background = '';
                        d.style.color = '';
                    }
                });
            }
        }

        // ===== –ù–û–í–´–ô –ü–û–¢–û–ö –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–ò =====
        
        // –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –∏–∑ API
        async function fetchAvailability({ signal }) {
            console.log('üåê [fetchAvailability] –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏');
            
            const selectedDuration = getSelectedDuration();
            const selectedLocation = getSelectedLocation();
            const serviceId = getServiceIdForLocation(selectedLocation, selectedDuration);
            
            const response = await fetch(`https://wakeme-booking-api.onrender.com/api/availability`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    service_id: serviceId,
                    start_date: new Date().toISOString().split('T')[0],
                    end_date: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]
                }),
                signal
            });
            
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const data = await response.json();
            
            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ –Ω—É–∂–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
            const dates = (data.available_dates || []).map(date => ({
                dateISO: date,
                hasFreeSlots: true,
                slotsCount: 0 // –ë—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–æ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–ª–æ—Ç–æ–≤
            }));
            
            console.log('üìä [fetchAvailability] –ü–æ–ª—É—á–µ–Ω—ã –¥–∞—Ç—ã:', dates);
            
            return {
                dates
            };
        }

        // –†–µ–Ω–¥–µ—Ä –∫–∞–ª–µ–Ω–¥–∞—Ä—è –∏–∑ –¥–∞–Ω–Ω—ã—Ö (–¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π)
        function renderCalendarFromData(availability) {
            console.log('üìÖ [renderCalendarFromData] –†–µ–Ω–¥–µ—Ä–∏–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å –∏–∑ –¥–∞–Ω–Ω—ã—Ö:', availability);
            
            const calendarGrid = document.querySelector('.calendar-grid');
            const calendarMonthDisplay = document.querySelector('.calendar-month');
            
            // –û—á–∏—â–∞–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å
            calendarGrid.innerHTML = '';
            
            const firstDayOfMonth = new Date(currentYear, currentMonth, 1).getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            
            calendarMonthDisplay.textContent = `${new Date(currentYear, currentMonth).toLocaleString('ru-RU', { month: 'long' })} ${currentYear}`;
            
            // –°–æ–∑–¥–∞–µ–º –ø—É—Å—Ç—ã–µ —è—á–µ–π–∫–∏ –¥–ª—è –Ω–∞—á–∞–ª–∞ –º–µ—Å—è—Ü–∞
            for (let i = 0; i < firstDayOfMonth; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'calendar-date empty';
                calendarGrid.appendChild(emptyCell);
            }
            
            // –°–æ–∑–¥–∞–µ–º –¥–∞—Ç—ã
            for (let i = 1; i <= daysInMonth; i++) {
                const dateElement = document.createElement('div');
                dateElement.className = 'calendar-date';
                
                const date = new Date(currentYear, currentMonth, i);
                const dateString = date.toISOString().split('T')[0];
                dateElement.dataset.date = dateString;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –∏–∑ –¥–∞–Ω–Ω—ã—Ö API
                const isAvailable = availability.dates.some(d => d.dateISO === dateString && d.hasFreeSlots);
                
                if (!isAvailable) {
                    dateElement.classList.add('disabled');
                }
                
                dateElement.textContent = i;
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞
                dateElement.addEventListener('click', () => {
                    if (dateElement.classList.contains('disabled')) return;
                    
                    console.log(`üñ±Ô∏è [renderCalendarFromData] –ö–ª–∏–∫ –ø–æ –¥–∞—Ç–µ: ${dateString}`);
                    selectDate(dateElement, dateString);
                    loadTimeSlots();
                });
                
                calendarGrid.appendChild(dateElement);
            }
        }

        // –í—ã–¥–µ–ª–µ–Ω–∏–µ –¥–∞—Ç—ã (—á–∏—Å—Ç–∞—è —Ñ—É–Ω–∫—Ü–∏—è)
        function highlightDate(dateISO) {
            console.log('üéØ [highlightDate] –í—ã–¥–µ–ª—è–µ–º –¥–∞—Ç—É:', dateISO);
            
            const dateElement = document.querySelector(`.calendar-date[data-date="${dateISO}"]`);
            if (dateElement && !dateElement.classList.contains('disabled')) {
                selectDate(dateElement, dateISO);
            }
        }

        // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å —Å–æ–±—ã—Ç–∏–π–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π
        async function initBooking({ cacheKey, fetchAvailability, renderCalendar, highlightDate, fetchSlots }) {
            const myRun = newRun();
            const controller = new AbortController();
            const { signal } = controller;

            console.log('üöÄ [initBooking] –ù–∞—á–∏–Ω–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é —Å runId:', myRun);

            try {
                // 1) –¢—è–Ω–µ–º –¥–∞–Ω–Ω—ã–µ. –ù–∏–∫–∞–∫–∏—Ö setTimeout.
                const availabilityPromise = getAvailability(cacheKey, fetchAvailability, signal);
                console.log('üì° [initBooking] –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏...');

                // 2) –ñ–¥–µ–º –¥–∞–Ω–Ω—ã–µ –∏ –ø–µ—Ä–≤—ã–π paint –∫–∞–ª–µ–Ω–¥–∞—Ä—è
                const [availability] = await Promise.all([
                    availabilityPromise,
                    waitFor('.calendar')
                ]);
                
                if (isStale(myRun)) {
                    console.log('‚èπÔ∏è [initBooking] Run —É—Å—Ç–∞—Ä–µ–ª, –æ—Ç–º–µ–Ω—è–µ–º');
                    return;
                }

                console.log('‚úÖ [initBooking] –î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã:', availability);

                // 3) –†–µ–Ω–¥–µ—Ä–∏–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å —Å—Ç—Ä–æ–≥–æ –∏–∑ –¥–∞–Ω–Ω—ã—Ö, –Ω–µ –∏–∑ DOM
                renderCalendar(availability);
                await afterPaint();
                if (isStale(myRun)) return;

                // 4) –í—ã–±–∏—Ä–∞–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—É—é –¥–∞—Ç—É –∏–∑ –¥–∞–Ω–Ω—ã—Ö, –Ω–µ –∏–∑ DOM
                const firstAvailable = availability.dates.find(d => d.hasFreeSlots);
                if (!firstAvailable) {
                    console.log('‚ùå [initBooking] –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤');
                    // –ë–ª–æ–∫–∏—Ä—É–µ–º UI
                    document.querySelectorAll('.calendar-date').forEach(d => d.classList.add('disabled'));
                    return;
                }

                console.log('üéØ [initBooking] –í—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—É—é –¥–æ—Å—Ç—É–ø–Ω—É—é –¥–∞—Ç—É:', firstAvailable.dateISO);
                highlightDate(firstAvailable.dateISO);
                await afterPaint();
                if (isStale(myRun)) return;

                // 5) –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ª–æ—Ç—ã —Å –æ—Ç–º–µ–Ω–æ–π
                console.log('‚è∞ [initBooking] –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ª–æ—Ç—ã –≤—Ä–µ–º–µ–Ω–∏...');
                const slots = await fetchSlots(firstAvailable.dateISO, { signal });
                if (isStale(myRun)) return;

                console.log('‚úÖ [initBooking] –°–ª–æ—Ç—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', slots);
                // renderSlots(slots); // –í–∞—à–∞ —Ñ—É–Ω–∫—Ü–∏—è —Ä–µ–Ω–¥–µ—Ä–∞ —Å–ª–æ—Ç–æ–≤

                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –æ—Ç–º–µ–Ω—ã
                return () => {
                    console.log('üõë [initBooking] –û—Ç–º–µ–Ω—è–µ–º —Ç–µ–∫—É—â—É—é –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é');
                    controller.abort();
                };

            } catch (error) {
                if (error.name === 'AbortError') {
                    console.log('‚èπÔ∏è [initBooking] –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞');
                } else {
                    console.error('‚ùå [initBooking] –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
                }
            }
        }

        // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è –æ—Ç–º–µ–Ω—ã
        let cancelCurrent = null;

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–º–µ–Ω—ã —É—Å–ª—É–≥–∏/–ª–æ–∫–∞—Ü–∏–∏ –±–µ–∑ –≥–æ–Ω–æ–∫
        async function onServiceOrLocationChange({ cacheKey, ...deps }) {
            console.log('üîÑ [onServiceOrLocationChange] –°–º–µ–Ω–∞ —É—Å–ª—É–≥–∏/–ª–æ–∫–∞—Ü–∏–∏');
            
            if (cancelCurrent) {
                console.log('üõë [onServiceOrLocationChange] –û—Ç–º–µ–Ω—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é');
                cancelCurrent(); // –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –≥–∞—Å–∏–º —Å—Ç–∞—Ä—ã–µ –∑–∞–ø—Ä–æ—Å—ã
            }
            
            cancelCurrent = await initBooking({ cacheKey, ...deps });
        }

        // –ñ–¥–∞—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—ã–±–æ—Ä–∞ –¥–∞—Ç—ã
        function waitForDateSelection() {
            return new Promise((resolve) => {
                let attempts = 0;
                const maxAttempts = 100; // 5 —Å–µ–∫—É–Ω–¥ –º–∞–∫—Å–∏–º—É–º
                
                const checkDateSelection = () => {
                    attempts++;
                    const selectedDate = document.querySelector('.calendar-date.selected');
                    const allDates = document.querySelectorAll('.calendar-date');
                    const availableDates = document.querySelectorAll('.calendar-date:not(.disabled)');
                    
                    console.log(`‚è≥ [waitForDateSelection] –ü–æ–ø—ã—Ç–∫–∞ ${attempts}/${maxAttempts}:`, {
                        selectedDate: selectedDate ? selectedDate.dataset.date : '–ù–ï–¢',
                        totalDates: allDates.length,
                        availableDates: availableDates.length,
                        disabledDates: document.querySelectorAll('.calendar-date.disabled').length
                    });
                    
                    if (selectedDate) {
                        console.log('‚úÖ [waitForDateSelection] –î–∞—Ç–∞ –≤—ã–±—Ä–∞–Ω–∞:', selectedDate.dataset.date);
                        resolve();
                    } else if (attempts >= maxAttempts) {
                        console.log('‚ùå [waitForDateSelection] –¢–∞–π–º–∞—É—Ç! –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º');
                        resolve();
                    } else {
                        setTimeout(checkDateSelection, 50);
                    }
                };
                checkDateSelection();
            });
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ –ª–æ–≥–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        function sendLogToServer(level, message, data = {}) {
            const logData = {
                level: level,
                message: message,
                data: data,
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent,
                url: window.location.href
            };
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
            fetch('https://wakeme-booking-api-production.up.railway.app/api/logs', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(logData)
            }).catch(err => {
                console.log('‚ùå [LOGS] –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ª–æ–≥–∞:', err);
            });
            
            // –¢–∞–∫–∂–µ –≤—ã–≤–æ–¥–∏–º –≤ –∫–æ–Ω—Å–æ–ª—å
            console.log(`üìù [${level}] ${message}`, data);
        }

        // –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–∞—Ç
        function startDateMonitoring() {
            let lastSelectedDate = null;
            
            // –°–æ–∑–¥–∞–µ–º –≤–∏–∑—É–∞–ª—å–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
            const debugPanel = document.createElement('div');
            debugPanel.id = 'debug-panel';
            debugPanel.style.cssText = `
                position: fixed;
                top: 10px;
                right: 10px;
                background: rgba(0,0,0,0.8);
                color: white;
                padding: 10px;
                border-radius: 5px;
                font-size: 12px;
                z-index: 9999;
                max-width: 200px;
                font-family: monospace;
            `;
            document.body.appendChild(debugPanel);
            
            setInterval(() => {
                const currentSelectedDate = document.querySelector('.calendar-date.selected');
                const currentDate = currentSelectedDate ? currentSelectedDate.dataset.date : null;
                const availableDates = document.querySelectorAll('.calendar-date:not(.disabled)').length;
                const totalDates = document.querySelectorAll('.calendar-date').length;
                
                if (currentDate !== lastSelectedDate) {
                    const logData = {
                        from: lastSelectedDate,
                        to: currentDate,
                        availableDates: availableDates,
                        totalDates: totalDates
                    };
                    
                    sendLogToServer('DATE_CHANGE', '–ò–∑–º–µ–Ω–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –¥–∞—Ç—ã', logData);
                    lastSelectedDate = currentDate;
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
                debugPanel.innerHTML = `
                    <div>üìÖ –î–∞—Ç–∞: ${currentDate || '–ù–ï–¢'}</div>
                    <div>üìä –î–æ—Å—Ç—É–ø–Ω–æ: ${availableDates}/${totalDates}</div>
                    <div>‚è∞ ${new Date().toLocaleTimeString()}</div>
                `;
            }, 100);
        }

        // Initialize
        // –ù–û–í–ê–Ø –ê–†–•–ò–¢–ï–ö–¢–£–†–ê: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å —Å–æ–±—ã—Ç–∏–π–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π
        console.log('üöÄ [INIT] –ù–∞—á–∏–Ω–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é —Å –Ω–æ–≤–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π');
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
        setDefaultSelections();
        startDateMonitoring();
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å –Ω–æ–≤–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π
        const selectedDuration = getSelectedDuration();
        const selectedLocation = getSelectedLocation();
        const cacheKey = `${selectedLocation}_${selectedDuration}`;
        
        console.log('üîÑ [INIT] –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å –Ω–æ–≤–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π –¥–ª—è:', cacheKey);
        
        initBooking({
            cacheKey,
            fetchAvailability,
            renderCalendar: renderCalendarFromData,
            highlightDate,
            fetchSlots: loadSlotsSafe
        }).then((cancelFn) => {
            if (cancelFn) {
                cancelCurrent = cancelFn;
                console.log('‚úÖ [INIT] –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞, —Ñ—É–Ω–∫—Ü–∏—è –æ—Ç–º–µ–Ω—ã —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞');
            }
        }).catch(error => {
            console.error('‚ùå [INIT] –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
        });
    </script>
</body>
</html>